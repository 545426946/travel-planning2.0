# 📱 微信授权登录测试步骤

## 🎯 测试目标

验证小程序能够成功获取用户的真实微信昵称和头像。

---

## ✅ 方法一：真机预览（推荐）

### 步骤

1. **打开微信开发者工具**
   - 确保项目已正确加载
   - 检查编译无错误

2. **点击"预览"按钮**
   - 位置：工具右上角
   - 或使用快捷键：`Ctrl + Shift + P`

3. **扫描二维码**
   - 用手机微信扫描生成的二维码
   - 等待小程序在手机上打开

4. **测试登录**
   - 进入登录页面
   - 切换到"微信登录"标签
   - 点击"微信授权登录"按钮

5. **授权操作**
   - 弹出授权窗口
   - 窗口显示：
     ```
     AI Travel 申请
     获取你的昵称、头像、地区及性别
     ```
   - 点击 **"允许"** 按钮

6. **验证结果** ✅
   - 登录成功提示
   - 自动跳转到首页
   - 查看个人中心
   - **应该显示你的真实微信昵称和头像**

---

## ✅ 方法二：真机调试

### 步骤

1. **打开真机调试**
   - 点击工具右上角"真机调试"
   - 或使用快捷键：`Ctrl + Shift + T`

2. **连接手机**
   - 用手机微信扫描二维码
   - 手机和电脑需在同一网络

3. **开始调试**
   - 手机上会自动打开小程序
   - 开发者工具显示手机日志

4. **测试登录**
   - 按照方法一的步骤 4-6 操作
   - 同时可以在开发者工具查看控制台日志

5. **查看日志**
   - 开发者工具 Console 会显示详细日志
   - 查找以下关键信息：
     ```
     ✅ 步骤2: wx.getUserProfile 成功
        - 昵称: [你的真实昵称]
        - 头像: [你的真实头像URL]
     ```

---

## ✅ 方法三：上传体验版

### 步骤

1. **上传代码**
   - 点击工具右上角"上传"
   - 填写版本号：如 `1.0.0`
   - 填写项目备注：如 `测试微信授权登录`
   - 点击"上传"

2. **设置体验版**
   - 登录[微信公众平台](https://mp.weixin.qq.com/)
   - 进入"管理" → "版本管理"
   - 找到刚上传的版本
   - 点击"设为体验版"

3. **添加体验成员**
   - "成员管理" → "体验成员"
   - 添加测试人员的微信号

4. **扫码体验**
   - 在"版本管理"找到体验版二维码
   - 体验成员用微信扫码
   - 按照方法一的步骤 4-6 测试

---

## 🔍 验证成功的标志

### 1. 控制台日志（真机调试时）

```
=========================================
🚀 用户点击微信授权登录按钮
=========================================
✅ 步骤1: wx.login 成功
   - code: 071Hxxxxxxxxx
✅ 步骤2: wx.getUserProfile 成功
   - 用户信息: {nickName: "张三", avatarUrl: "https://...", ...}
   - 昵称: 张三                    ← 你的真实昵称
   - 头像: https://thirdwx.qlogo.cn/... ← 你的真实头像
   - 性别: 1
   - 城市: 深圳
   - 省份: 广东
   - 国家: 中国
=========================================
🔄 步骤3: 处理登录数据
=========================================
📦 构建的用户数据:
   - 昵称: 张三
   - 真实信息: ✅ 是
💾 保存用户信息到数据库...
✅ 用户信息已保存到数据库
✅ 微信登录完成，1.5秒后跳转首页
```

### 2. 界面显示

- **登录成功toast**: "登录成功"
- **首页顶部**: 显示你的真实微信昵称
- **个人中心**: 显示你的真实微信头像和昵称

### 3. 本地存储验证

在真机调试时，可以在 Console 运行：
```javascript
wx.getStorageSync('userInfo')
```

应该返回包含真实信息的对象：
```javascript
{
  name: "你的真实昵称",
  avatar: "你的真实头像URL",
  hasRealInfo: true,
  ...
}
```

---

## ❌ 失败的情况

### 情况1: 显示"游客xxxx"

**可能原因**:
- 在开发者工具模拟器中测试（不支持）
- 基础库版本过低
- 未配置隐私保护指引

**解决方法**:
- ✅ 使用真机预览
- ✅ 检查基础库版本 >= 2.10.4
- ✅ 配置隐私保护指引

### 情况2: 授权窗口不弹出

**可能原因**:
- API 调用失败
- 网络问题

**解决方法**:
- 查看控制台错误信息
- 检查网络连接
- 重启小程序

### 情况3: 点击"允许"后无反应

**可能原因**:
- 代码逻辑错误
- 数据库连接失败

**解决方法**:
- 查看控制台日志
- 检查 Supabase 配置
- 尝试使用游客模式

---

## 📋 测试检查清单

测试前确认：

- [ ] 项目编译无错误
- [ ] `app.json` 包含 `requiredPrivateInfos`
- [ ] 基础库版本 >= 2.10.4
- [ ] 手机和电脑在同一网络（真机调试时）
- [ ] 微信已登录（真机预览时）

测试中验证：

- [ ] 点击登录按钮有反应
- [ ] 弹出授权窗口
- [ ] 窗口显示正确的申请内容
- [ ] 点击"允许"后成功登录
- [ ] 显示真实昵称和头像
- [ ] 控制台日志正确

测试后确认：

- [ ] 登录状态已保存
- [ ] 刷新后仍保持登录
- [ ] 退出登录功能正常
- [ ] 重新登录可以更新信息

---

## 💡 测试技巧

### 1. 快速测试

使用真机预览是最快的方式：
```
开发者工具 → 预览 → 手机扫码 → 直接测试
```

### 2. 查看详细日志

真机调试可以看到完整的执行流程：
```
开发者工具 → 真机调试 → 查看 Console
```

### 3. 清除缓存重测

如需重新测试授权流程：
```
手机微信 → 发现 → 小程序 → 删除小程序
重新扫码 → 首次使用会重新请求授权
```

### 4. 多设备测试

建议在不同的手机上测试：
- iOS 设备
- Android 设备
- 不同微信版本

---

## 📞 遇到问题？

### 查看文档
- [微信授权登录使用指南.md](./微信授权登录使用指南.md)
- [快速排查.txt](./快速排查.txt)

### 常见问题
- 开发工具显示游客 → 正常，使用真机测试
- 真机也显示游客 → 检查配置和版本
- 授权窗口不弹出 → 检查 API 调用

---

**祝测试顺利！** 🎉

如果所有步骤都正确，你应该能够在真机上看到自己的真实微信昵称和头像！
