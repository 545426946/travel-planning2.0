# 微信登录故障排查指南

## 📋 常见失败原因和解决方案

### 1. ⚠️ getUserProfile 接口调用失败

**错误信息**: `getUserProfile:fail auth deny` 或 `getUserProfile:fail`

**可能原因**:
- 用户点击了"拒绝"按钮
- 微信基础库版本过低(需要 ≥ 2.10.4)
- 没有通过 button 组件调用

**解决方案**:
```javascript
// ✅ 正确做法: 使用 button 的 bindtap
<button bindtap="wechatLogin">微信一键登录</button>

// ❌ 错误做法: 使用 view 的 bindtap
<view bindtap="wechatLogin">微信一键登录</view>
```

**检查微信基础库版本**:
1. 打开微信开发者工具
2. 点击右上角"详情"
3. 查看"本地设置" → "调试基础库"
4. 确保版本 ≥ 2.10.4

---

### 2. ⚠️ wx.login 接口调用失败

**错误信息**: `login:fail` 或 无法获取 code

**可能原因**:
- 网络问题
- AppID 配置错误
- 微信服务器异常

**解决方案**:
1. **检查网络连接**
2. **验证 AppID 配置**:
   ```json
   // project.config.json
   {
     "appid": "wxb9ca37c30f43d5b8"  // 确认这是正确的 AppID
   }
   ```
3. **在真机上测试**(开发者工具可能有限制)

---

### 3. ⚠️ 数据库连接失败

**错误信息**: `创建用户失败` 或 `保存用户到数据库失败`

**可能原因**:
- Supabase 配置错误
- 网络问题
- 数据库表结构不匹配

**解决方案**:
1. **检查 Supabase 配置**:
   ```javascript
   // utils/config.js
   export const SUPABASE_URL = 'https://hmnjuntvubqvbpeyqoxw.supabase.co'
   export const SUPABASE_ANON_KEY = '你的密钥'
   ```

2. **验证数据库表结构**:
   ```sql
   -- users 表必须包含以下字段
   CREATE TABLE users (
     id SERIAL PRIMARY KEY,
     name VARCHAR(255),
     avatar TEXT,
     gender INTEGER,
     city VARCHAR(100),
     province VARCHAR(100),
     country VARCHAR(100),
     login_type VARCHAR(50),
     created_at TIMESTAMP,
     last_login TIMESTAMP
   );
   ```

3. **测试数据库连接**:
   ```javascript
   // 在控制台运行
   const supabase = require('./utils/supabase').supabase
   supabase.from('users').select('id').limit(1).then(console.log)
   ```

**注意**: 即使数据库失败,现在的代码也会继续登录流程,只是不会保存到数据库

---

### 4. ⚠️ 页面跳转失败

**错误信息**: 跳转失败或卡在登录页

**可能原因**:
- 页面路径配置错误
- tabBar 配置问题

**解决方案**:
1. **检查 app.json 配置**:
   ```json
   {
     "pages": [
       "index/index",  // 确保首页路径正确
       "pages/login/login"
     ]
   }
   ```

2. **使用正确的跳转方法**:
   ```javascript
   // ✅ 跳转到 tabBar 页面
   wx.switchTab({ url: '/pages/index/index' })
   
   // ❌ 错误: 使用 navigateTo 跳转 tabBar
   wx.navigateTo({ url: '/pages/index/index' })
   ```

---

## 🔍 调试技巧

### 1. 查看完整日志
打开微信开发者工具控制台,查看详细日志:
```
=== 开始微信登录流程 ===
✅ wx.login 成功, code: 071xxxxx
✅ 获取用户信息成功: {...}
✅ 用户数据构建完成: {...}
📝 尝试保存用户信息到数据库...
✅ 登录用户信息: {...}
✅ 登录状态已保存
🏠 跳转到首页
```

### 2. 分步测试

#### 步骤1: 测试 wx.login
```javascript
wx.login({
  success: (res) => console.log('✅ wx.login 成功:', res),
  fail: (err) => console.error('❌ wx.login 失败:', err)
})
```

#### 步骤2: 测试 getUserProfile
```javascript
// 必须在 button 的 bindtap 中调用
wx.getUserProfile({
  desc: '测试',
  success: (res) => console.log('✅ getUserProfile 成功:', res),
  fail: (err) => console.error('❌ getUserProfile 失败:', err)
})
```

#### 步骤3: 测试数据库
```javascript
const supabase = require('./utils/supabase').supabase
supabase.from('users').select('*').limit(1)
  .then(res => console.log('✅ 数据库连接成功:', res))
  .catch(err => console.error('❌ 数据库连接失败:', err))
```

---

## 🛠️ 快速修复清单

### 开发环境测试
- [ ] 微信基础库版本 ≥ 2.10.4
- [ ] AppID 配置正确
- [ ] 使用 button 组件触发登录
- [ ] 网络连接正常
- [ ] Supabase 配置正确

### 真机测试
- [ ] 使用体验版或开发版
- [ ] 微信版本 ≥ 7.0.9
- [ ] 允许网络访问权限
- [ ] 检查真机日志

### 代码检查
- [ ] button 使用 `bindtap="wechatLogin"`
- [ ] getUserProfile 在 button 回调中
- [ ] 错误处理完善
- [ ] 日志输出清晰

---

## 📱 真机测试步骤

1. **点击"预览"生成二维码**
2. **使用微信扫码**
3. **打开小程序**
4. **点击"微信一键登录"**
5. **点击"允许"授权**
6. **查看是否登录成功**

### 真机调试
1. **点击"真机调试"**
2. **扫码连接手机**
3. **在开发者工具中查看真机日志**
4. **定位具体问题**

---

## 🎯 最佳实践

### 1. 优雅的错误处理
```javascript
try {
  const userInfo = await getUserProfile()
  // 处理用户信息
} catch (error) {
  if (error.errMsg.includes('auth deny')) {
    wx.showModal({
      title: '需要授权',
      content: '为了提供更好的服务,我们需要获取您的基本信息',
      success: (res) => {
        if (res.confirm) {
          // 用户重新点击授权
        }
      }
    })
  }
}
```

### 2. 降级方案
如果 getUserProfile 失败,可以提供其他登录方式:
- 账号密码登录
- 手机号登录
- 游客模式

### 3. 用户引导
```javascript
wx.showModal({
  title: '授权说明',
  content: '我们需要获取您的昵称和头像,用于:\n1. 个性化展示\n2. 社交互动\n3. 提供更好的服务',
  confirmText: '授权',
  cancelText: '取消'
})
```

---

## 📞 需要帮助?

如果以上方法都无法解决问题:

1. **查看控制台完整错误信息**
2. **截图错误日志**
3. **记录复现步骤**
4. **检查微信开放社区是否有类似问题**

---

## 🔄 更新日志

- **2024-11-21**: 优化错误处理,即使数据库失败也能继续登录
- **2024-11-21**: 添加详细日志输出
- **2024-11-21**: 改进用户体验
