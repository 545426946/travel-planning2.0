# ğŸš€ å¾®ä¿¡ç™»å½•éƒ¨ç½²æ“ä½œæ­¥éª¤

## ğŸ“‹ å½“å‰çŠ¶æ€æ£€æŸ¥

âœ… **å·²å®Œæˆçš„é¡¹ç›®ç»“æ„**ï¼š
```
travel-planning2.0/
â”œâ”€â”€ supabase/                    âœ… å·²åˆ›å»º
â”‚   â”œâ”€â”€ functions/
â”‚   â”‚   â””â”€â”€ wechat-login/        âœ… å·²åˆ›å»º
â”‚   â”‚       â”œâ”€â”€ index.ts           âœ… Edge Function ä»£ç 
â”‚   â”‚       â””â”€â”€ deno.json         âœ… é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ 20241124_create_wechat_login_tables.sql âœ… æ•°æ®åº“è¡¨ç»“æ„
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ wechat-login.js          âœ… å·²æ›´æ–°é€‚é… Supabase
â””â”€â”€ pages/login/
    â”œâ”€â”€ login.js                 âœ… å·²æ›´æ–°ä½¿ç”¨æ–°æ–¹æ³•
    â””â”€â”€ login.wxml               âœ… å·²æ›´æ–°æŒ‰é’®
```

## ğŸ› ï¸ æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå®‰è£… Supabase CLI

**æ–¹æ³•1: é€šè¿‡ npm (æ¨è)**
```bash
# ä½¿ç”¨ npm æº
npm install -g @supabase/supabase-js@2

# æˆ–è€…ç›´æ¥å®‰è£… CLI
npm install -g supabase
```

**æ–¹æ³•2: é€šè¿‡ PowerShell (Windows)**
```powershell
# ä½¿ç”¨ PowerShell å®‰è£…
Install-Module -Name supabase

# æˆ–è€…ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
Invoke-WebRequest -Uri "https://github.com/supabase/cli/releases/latest/download/supabase-windows-amd64.exe" -OutFile "supabase.exe"
```

**æ–¹æ³•3: ç›´æ¥ä½¿ç”¨å¯æ‰§è¡Œæ–‡ä»¶**
1. è®¿é—®ï¼šhttps://github.com/supabase/cli/releases
2. ä¸‹è½½æœ€æ–°ç‰ˆçš„ `supabase-windows-amd64.exe`
3. å°†å…¶æ·»åŠ åˆ°ç³»ç»Ÿ PATH

### ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ– Supabase é¡¹ç›®

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd "c:/Users/Administrator/Desktop/æ—…æ¸¸ç®¡ç†ç³»ç»Ÿ2.0/travel-planning2.0"

# é“¾æ¥åˆ°ä½ çš„ Supabase é¡¹ç›®ï¼ˆéœ€è¦ä½ çš„é¡¹ç›® URLï¼‰
supabase link --project-ref "your-project-ref"

# æˆ–è€…ç›´æ¥åˆå§‹åŒ–
supabase init
```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

åœ¨ Supabase Dashboard â†’ Settings â†’ Edge Functions ä¸­æ·»åŠ ï¼š

```bash
# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_APP_SECRET=your_32_char_secret_here

# JWT é…ç½®
JWT_SECRET=your_jwt_secret_key_at_least_32_chars

# æ•°æ®åº“é…ç½®ï¼ˆè‡ªåŠ¨æ·»åŠ ï¼‰
SUPABASE_URL=https://hmnjuntvubqvbpeyqoxw.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhtbmp1bnR2dWJxdmJwZXlxb3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MjEwNDYsImV4cCI6MjA3ODk5NzA0Nn0.BCp0_8M3OhlIhLQ4fz54le-sWqZeUx9JDRXr1XRsX8g
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
```

### ç¬¬å››æ­¥ï¼šéƒ¨ç½² Edge Function

```bash
# éƒ¨ç½²å¾®ä¿¡ç™»å½•å‡½æ•°
supabase functions deploy wechat-login

# æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
supabase functions list
```

### ç¬¬äº”æ­¥ï¼šåˆ›å»ºæ•°æ®åº“è¡¨

**æ–¹æ³•1: é€šè¿‡ Supabase Dashboard**
1. æ‰“å¼€ Supabase Dashboard
2. è¿›å…¥ SQL Editor
3. å¤åˆ¶å¹¶ç²˜è´´ `supabase/migrations/20241124_create_wechat_login_tables.sql` çš„å†…å®¹
4. ç‚¹å‡» "Run" æ‰§è¡Œ

**æ–¹æ³•2: é€šè¿‡ CLI**
```bash
# æ¨é€æ•°æ®åº“å˜æ›´
supabase db push
```

## ğŸ”§ é…ç½®éªŒè¯

### éªŒè¯ Edge Function

```bash
# æœ¬åœ°æµ‹è¯•
supabase functions serve --no-verify-jwt

# æµ‹è¯• API è°ƒç”¨
curl -X POST "https://hmnjuntvubqvbpeyqoxw.supabase.co/functions/v1/wechat-login" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{"code": "test_code"}'
```

### éªŒè¯æ•°æ®åº“è¡¨

```sql
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
SELECT table_name, column_name, data_type 
FROM information_schema.columns 
WHERE table_name IN ('users', 'user_sessions', 'login_logs')
ORDER BY table_name, ordinal_position;
```

## ğŸ“± å°ç¨‹åºç«¯æµ‹è¯•

### æ›´æ–°é…ç½®æ–‡ä»¶

ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶ä¸­çš„é…ç½®æ­£ç¡®ï¼š

**utils/supabase.js**
```javascript
const supabaseUrl = 'https://hmnjuntvubqvbpeyqoxw.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhtbmp1bnR2dWJxdmJwZXlxb3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MjEwNDYsImV4cCI6MjA3ODk5NzA0Nn0.BCp0_8M3OhlIhLQ4fz54le-sWqZeUx9JDRXr1XRsX8g'
```

**pages/login/login.js**
```javascript
// ç¡®ä¿ä½¿ç”¨äº†æ–°çš„ç™»å½•æ–¹æ³•
const { wechatLogin } = require('../../utils/wechat-login').wechatLogin

async handleWechatLoginOfficial() {
  const loginResult = await wechatLogin.login()
  // å¤„ç†ç™»å½•ç»“æœ
}
```

### å¼€å‘è€…å·¥å…·æµ‹è¯•

1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. å¯¼å…¥é¡¹ç›®
3. å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"
4. ç‚¹å‡»"å¾®ä¿¡ç™»å½•"æŒ‰é’®
5. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1: Edge Function éƒ¨ç½²å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ TypeScript è¯­æ³•
deno check supabase/functions/wechat-login/index.ts

# æœ¬åœ°æµ‹è¯•
supabase functions serve --no-verify-jwt
```

### é—®é¢˜2: ç¯å¢ƒå˜é‡æœªè®¾ç½®
**è§£å†³æ–¹æ¡ˆ**:
```bash
# éªŒè¯ç¯å¢ƒå˜é‡
supabase secrets list

# è®¾ç½®ç¼ºå¤±çš„å˜é‡
supabase secrets set WECHAT_APP_ID=wx1234567890abcdef
supabase secrets set WECHAT_APP_SECRET=your_secret
```

### é—®é¢˜3: æ•°æ®åº“è¡¨åˆ›å»ºå¤±è´¥
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ SQL è¯­æ³•
- é€æ®µæ‰§è¡Œ SQL
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—

### é—®é¢˜4: å¾®ä¿¡ç™»å½•ä¸å·¥ä½œ
**è°ƒè¯•æ­¥éª¤**:
1. æ£€æŸ¥å°ç¨‹åºç«¯æ§åˆ¶å°æ—¥å¿—
2. æ£€æŸ¥ Edge Function æ—¥å¿—
3. æ£€æŸ¥ç½‘ç»œè¯·æ±‚
4. éªŒè¯å¾®ä¿¡é…ç½®

## ğŸ“‹ å®Œæˆæ¸…å•

### âœ… Supabase é…ç½®
- [ ] CLI å·²å®‰è£…
- [ ] é¡¹ç›®å·²é“¾æ¥
- [ ] ç¯å¢ƒå˜é‡å·²è®¾ç½®
- [ ] Edge Function å·²éƒ¨ç½²
- [ ] æ•°æ®åº“è¡¨å·²åˆ›å»º

### âœ… å°ç¨‹åºé…ç½®
- [ ] Supabase URL å’Œ Key å·²é…ç½®
- [ ] å¾®ä¿¡ç™»å½•æœåŠ¡å·²é›†æˆ
- [ ] ç™»å½•é¡µé¢å·²æ›´æ–°
- [ ] é”™è¯¯å¤„ç†å·²æµ‹è¯•

### âœ… åŠŸèƒ½æµ‹è¯•
- [ ] Edge Function æ­£å¸¸å“åº”
- [ ] å¾®ä¿¡ç™»å½•æµç¨‹å®Œæ•´
- [ ] ç”¨æˆ·æ•°æ®æ­£ç¡®ä¿å­˜
- [ ] é”™è¯¯æƒ…å†µæ­£ç¡®å¤„ç†

## ğŸ‰ é¢„æœŸç»“æœ

éƒ¨ç½²å®Œæˆåï¼š

1. **Edge Function** è¿è¡Œåœ¨ `https://hmnjuntvubqvbpeyqoxw.supabase.co/functions/v1/wechat-login`
2. **æ•°æ®åº“è¡¨** åŒ…å«å®Œæ•´çš„ç”¨æˆ·å’Œä¼šè¯ç®¡ç†
3. **å°ç¨‹åºç«¯** å¯ä»¥æ­£å¸¸è°ƒç”¨å¾®ä¿¡ç™»å½•
4. **å®‰å…¨æ€§** ç¬¦åˆå¾®ä¿¡å’Œ Supabase æœ€ä½³å®è·µ

## ğŸ†˜ï¸ è·å–å¸®åŠ©

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **Supabase æ–‡æ¡£**: https://supabase.com/docs
2. **å¾®ä¿¡å°ç¨‹åºæ–‡æ¡£**: https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html
3. **é¡¹ç›® GitHub**: æŸ¥çœ‹å®Œæ•´ä»£ç å’Œé…ç½®

---

**ğŸš€ æŒ‰ç…§è¿™äº›æ­¥éª¤æ“ä½œï¼Œä½ å°±èƒ½æˆåŠŸéƒ¨ç½²å®Œæ•´çš„å¾®ä¿¡ç™»å½•ç³»ç»Ÿï¼**