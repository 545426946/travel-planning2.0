# å¾®ä¿¡ç™»å½•å¤±è´¥æ’æŸ¥æŒ‡å—

## ğŸš¨ å¸¸è§ç™»å½•å¤±è´¥åŸå› åŠè§£å†³æ–¹æ¡ˆ

### 1. Edge Function æœªéƒ¨ç½² âŒ

**é—®é¢˜è¡¨ç°ï¼š**
- ç™»å½•æ—¶æç¤º "æœåŠ¡å™¨ç¹å¿™" æˆ– "ç½‘ç»œè¿æ¥å¤±è´¥"
- æ§åˆ¶å°æ˜¾ç¤º Edge Function è¯·æ±‚å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. ç™»å½• Supabase CLI
supabase login

# 2. é“¾æ¥åˆ°ä½ çš„é¡¹ç›®
supabase link --project-ref hmnjuntvubqvbpeyqoxw

# 3. éƒ¨ç½² Edge Functions
supabase functions deploy wechat-login

# 4. æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
supabase functions list
```

### 2. å¾®ä¿¡å°ç¨‹åºé…ç½®ç¼ºå¤± âŒ

**é—®é¢˜è¡¨ç°ï¼š**
- AppID ä¸ºç©ºæˆ–é»˜è®¤å€¼
- å¾®ä¿¡æœåŠ¡å™¨è¿”å› "æ— æ•ˆçš„ AppID"

**è§£å†³æ–¹æ¡ˆï¼š**

#### æ­¥éª¤ 1ï¼šè·å–å¾®ä¿¡å°ç¨‹åº AppID
1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com)
2. è¿›å…¥å°ç¨‹åºç®¡ç†åå°
3. å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½® â†’ å¼€å‘è€…IDï¼ˆAppIDï¼‰

#### æ­¥éª¤ 2ï¼šé…ç½® Edge Function ç¯å¢ƒå˜é‡
```bash
# è®¾ç½®å¾®ä¿¡å°ç¨‹åºé…ç½®
supabase secrets set WECHAT_APP_ID="ä½ çš„å°ç¨‹åºAppID"
supabase secrets set WECHAT_APP_SECRET="ä½ çš„å°ç¨‹åºAppSecret"

# éªŒè¯ç¯å¢ƒå˜é‡
supabase secrets list
```

#### æ­¥éª¤ 3ï¼šæ›´æ–°é¡¹ç›®é…ç½®
åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
1. `project.config.json` ç¡®è®¤ `appid` æ­£ç¡®
2. `app.json` ç¡®è®¤æƒé™é…ç½®æ­£ç¡®

### 3. ç½‘ç»œè¯·æ±‚è¢«é˜»æ­¢ âŒ

**é—®é¢˜è¡¨ç°ï¼š**
- æ§åˆ¶å°æ˜¾ç¤º "request:fail url not in domain list"
- HTTPS è¯ä¹¦é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**

#### å¾®ä¿¡å°ç¨‹åºåŸŸåç™½åå•é…ç½®
åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æ·»åŠ ä»¥ä¸‹åŸŸåï¼š
- requeståˆæ³•åŸŸåï¼š`https://hmnjuntvubqvbpeyqoxw.supabase.co`
- requeståˆæ³•åŸŸåï¼š`https://api.weixin.qq.com`

#### æœ¬åœ°å¼€å‘é…ç½®
åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼š
- è¯¦æƒ… â†’ æœ¬åœ°è®¾ç½® â†’ ä¸æ ¡éªŒåˆæ³•åŸŸåã€web-viewï¼ˆä¸šåŠ¡åŸŸåï¼‰ã€TLSç‰ˆæœ¬ä»¥åŠHTTPSè¯ä¹¦

### 4. æ•°æ®åº“è¿æ¥é—®é¢˜ âŒ

**é—®é¢˜è¡¨ç°ï¼š**
- æ•°æ®åº“æŸ¥è¯¢å¤±è´¥
- ç”¨æˆ·ä¿¡æ¯æ— æ³•ä¿å­˜

**è§£å†³æ–¹æ¡ˆï¼š**
```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
SELECT table_name, table_schema 
FROM information_schema.tables 
WHERE table_schema IN ('public', 'auth');

-- æ£€æŸ¥ RLS ç­–ç•¥
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE tablename IN ('users', 'user_sessions');
```

### 5. ä»£ç é€»è¾‘é”™è¯¯ âŒ

**å¸¸è§é”™è¯¯åŠä¿®å¤ï¼š**

#### é”™è¯¯ 1ï¼šæ¨¡å—å¯¼å…¥å¤±è´¥
```javascript
// âŒ é”™è¯¯
const { wechatLogin } = require('../../utils/wechat-login').wechatLogin

// âœ… æ­£ç¡®
const { wechatLogin } = require('../../utils/wechat-login')
```

#### é”™è¯¯ 2ï¼šAPI è°ƒç”¨é”™è¯¯
```javascript
// âŒ é”™è¯¯ - ç¡¬ç¼–ç é…ç½®
const supabaseUrl = 'https://hmnjuntvubqvbpeyqoxw.supabase.co'

// âœ… æ­£ç¡® - ä»ç¯å¢ƒå˜é‡è¯»å–
const { supabase } = require('./supabase')
```

## ğŸ” è°ƒè¯•æ­¥éª¤

### 1. æ£€æŸ¥ Edge Function çŠ¶æ€
```bash
supabase functions logs wechat-login
```

### 2. æ£€æŸ¥ç¯å¢ƒå˜é‡
```bash
supabase secrets list
```

### 3. æµ‹è¯•æ•°æ®åº“è¿æ¥
```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
const { supabase } = require('../../utils/supabase')
supabase.from('users').select('*').limit(1).then(console.log)
```

### 4. æµ‹è¯•å¾®ä¿¡ç™»å½•æµç¨‹
```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
const { wechatLogin } = require('../../utils/wechat-login')
wechatLogin.login().then(console.log)
```

## ğŸ› ï¸ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœ Edge Function æš‚æ—¶æ— æ³•ä½¿ç”¨ï¼Œå¯ä»¥å¯ç”¨æœ¬åœ°æ¨¡å¼ï¼š

```javascript
// utils/wechat-login.js
async sendCodeToServer(code) {
  try {
    // å¼ºåˆ¶ä½¿ç”¨æœ¬åœ° fallback
    console.log('ğŸ”„ å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°å¤„ç†æ¨¡å¼')
    return await this.localWechatLoginFallback(code)
  } catch (error) {
    console.error('âŒ æœ¬åœ°ç™»å½•ä¹Ÿå¤±è´¥:', error)
    throw error
  }
}
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [ ] å¾®ä¿¡å°ç¨‹åº AppID å·²æ­£ç¡®é…ç½®
- [ ] Edge Function å·²éƒ¨ç½²
- [ ] ç¯å¢ƒå˜é‡å·²è®¾ç½®
- [ ] åŸŸåç™½åå•å·²é…ç½®
- [ ] æ•°æ®åº“è¡¨å·²åˆ›å»º
- [ ] RLS ç­–ç•¥å·²é…ç½®
- [ ] ç½‘ç»œè¯·æ±‚æƒé™å·²å¼€å¯

## ğŸš€ å¿«é€Ÿä¿®å¤å‘½ä»¤

```bash
# 1. å®Œæ•´é‡æ–°éƒ¨ç½²
supabase functions deploy wechat-login --no-verify-jwt

# 2. è®¾ç½®æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡
supabase secrets set WECHAT_APP_ID=\"wx31db19e0efdc4d9d\"
supabase secrets set WECHAT_APP_SECRET="your_app_secret_here"

# 3. æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
supabase functions list
supabase secrets list
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. å¾®ä¿¡å¼€å‘è€…å·¥å…·æ§åˆ¶å°å®Œæ•´æ—¥å¿—
2. Supabase Edge Function æ—¥å¿—
3. ç½‘ç»œè¯·æ±‚è¯¦ç»†ä¿¡æ¯
4. é”™è¯¯å‘ç”Ÿçš„å…·ä½“æ­¥éª¤