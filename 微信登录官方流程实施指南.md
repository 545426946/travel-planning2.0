# ğŸš€ å¾®ä¿¡ç™»å½•å®˜æ–¹æµç¨‹å®Œæ•´å®æ–½æŒ‡å—

## ğŸ“‹ æ ¸å¿ƒæµç¨‹æ¦‚è§ˆ

æŒ‰ç…§å¾®ä¿¡å®˜æ–¹æ¨èçš„ä¸‰æ–¹äº¤äº’æµç¨‹ï¼š

```mermaid
graph TD
    A[å°ç¨‹åºç«¯] --> B[è°ƒç”¨ wx.login() è·å– code]
    B --> C[å‘é€ code åˆ°åç«¯æœåŠ¡å™¨]
    C --> D[åç«¯å‘å¾®ä¿¡æœåŠ¡å™¨è¯·æ±‚]
    D --> E[æ¢å– OpenID å’Œ session_key]
    E --> F[åç«¯ç”Ÿæˆè‡ªå®šä¹‰ token]
    F --> G[è¿”å› token ç»™å°ç¨‹åºç«¯]
    G --> H[å°ç¨‹åºç«¯ä¿å­˜ token]
    H --> I[åç»­è¯·æ±‚æºå¸¦ token]
```

## ğŸ”§ ç¬¬ä¸€é˜¶æ®µï¼šå°ç¨‹åºç«¯å®ç°

### 1. ğŸ“± å¾®ä¿¡ç™»å½•æœåŠ¡ï¼ˆå·²å®Œæˆï¼‰

**æ–‡ä»¶**: `utils/wechat-login.js`

**æ ¸å¿ƒæ–¹æ³•**:
```javascript
class WechatLogin {
  // ä¸»ç™»å½•æ–¹æ³•
  async login() {
    const code = await this.getWxLoginCode()      // 1. è·å– code
    const result = await this.sendCodeToServer(code)  // 2. å‘é€åˆ°æœåŠ¡å™¨
    this.saveLoginToken(result.token, result.userInfo) // 3. ä¿å­˜ token
  }
}
```

**ä½¿ç”¨æ–¹å¼**:
```javascript
const { wechatLogin } = require('../../utils/wechat-login')

// åœ¨ç™»å½•é¡µé¢ä¸­ä½¿ç”¨
async handleWechatLogin() {
  const result = await wechatLogin.login()
  if (result.success) {
    // ç™»å½•æˆåŠŸï¼Œè·³è½¬é¦–é¡µ
    this.redirectToHome()
  }
}
```

### 2. ğŸ¯ ç™»å½•é¡µé¢ï¼ˆå·²æ›´æ–°ï¼‰

**æ–‡ä»¶**: `pages/login/login.js`

**å…³é”®æ›´æ–°**:
```javascript
// å¯¼å…¥å¾®ä¿¡ç™»å½•æœåŠ¡
const { wechatLogin } = require('../../utils/wechat-login').wechatLogin

// ä½¿ç”¨å®˜æ–¹æµç¨‹çš„ç™»å½•æ–¹æ³•
async handleWechatLoginOfficial() {
  const loginResult = await wechatLogin.login()
  // å¤„ç†ç™»å½•ç»“æœ
}
```

**é¡µé¢é…ç½®**:
```xml
<!-- ç®€åŒ–çš„ç™»å½•æŒ‰é’® -->
<button 
  class="login-btn wechat-btn" 
  bindtap="handleWechatLoginOfficial"
  loading="{{isLoading}}"
>
  å¾®ä¿¡ç™»å½•
</button>
```

## ğŸ–¥ï¸ ç¬¬äºŒé˜¶æ®µï¼šåç«¯æœåŠ¡å™¨å®ç°

### 1. ğŸ“¡ API æœåŠ¡å™¨ç¤ºä¾‹ï¼ˆå·²åˆ›å»ºï¼‰

**æ–‡ä»¶**: `api-examples/wechat-login-api.js`

**æ ¸å¿ƒ API ç«¯ç‚¹**:

#### POST /api/wechat/login
```javascript
// æ¥æ”¶å°ç¨‹åºç«¯çš„ code
app.post('/api/wechat/login', async (req, res) => {
  const { code } = req.body
  
  // 1. å‘å¾®ä¿¡æœåŠ¡å™¨è¯·æ±‚
  const wechatResponse = await getWechatUserInfo(code)
  const { openid, session_key } = wechatResponse.data
  
  // 2. ç”Ÿæˆè‡ªå®šä¹‰ token
  const customToken = generateCustomToken(openid, session_key)
  
  // 3. è¿”å›ç»™å°ç¨‹åº
  res.json({
    success: true,
    token: customToken,
    userInfo: { openid }
  })
})
```

#### å‘å¾®ä¿¡æœåŠ¡å™¨è¯·æ±‚
```javascript
async function getWechatUserInfo(code) {
  const url = 'https://api.weixin.qq.com/sns/jscode2session'
  const params = {
    appid: YOUR_APPID,
    secret: YOUR_APPSECRET,
    js_code: code,
    grant_type: 'authorization_code'
  }
  
  const response = await axios.get(url, { params })
  return { success: true, data: response.data }
}
```

### 2. ğŸ” Token ç®¡ç†ç³»ç»Ÿ

**ç”Ÿæˆ Token**:
```javascript
function generateCustomToken(openid, sessionKey) {
  const payload = {
    openid,
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + (30 * 24 * 60 * 60) // 30å¤©
  }
  
  return jwt.sign(payload, 'your_jwt_secret_key')
}
```

**éªŒè¯ Token ä¸­é—´ä»¶**:
```javascript
function authenticateToken(req, res, next) {
  const token = req.headers.authorization?.split(' ')[1]
  
  try {
    const decoded = jwt.verify(token, 'your_jwt_secret_key')
    req.user = { openid: decoded.openid }
    next()
  } catch (error) {
    res.status(401).json({ message: 'token æ— æ•ˆ' })
  }
}
```

## ğŸ”§ ç¬¬ä¸‰é˜¶æ®µï¼šé…ç½®å’Œéƒ¨ç½²

### 1. ğŸ”‘ å¿…éœ€é…ç½®

#### å°ç¨‹åºé…ç½®
```json
// app.json
{
  "permission": {
    "scope.userInfo": {
      "desc": "æ‚¨çš„å¾®ä¿¡ä¿¡æ¯å°†ç”¨äºå®Œå–„ä¼šå‘˜èµ„æ–™"
    }
  }
}
```

#### æœåŠ¡å™¨é…ç½®
```javascript
// wechat-login-api.js
const WECHAT_CONFIG = {
  appId: 'your_mini_program_appid',      // âš ï¸ å¿…é¡»æ›¿æ¢
  appSecret: 'your_mini_program_appsecret' // âš ï¸ å¿…é¡»æ›¿æ¢
}
```

#### å°ç¨‹åºç«¯é…ç½®
```javascript
// utils/wechat-login.js
class WechatLogin {
  constructor() {
    this.serverUrl = 'your_server_url' // âš ï¸ å¿…é¡»æ›¿æ¢ä¸ºå®é™…æœåŠ¡å™¨åœ°å€
  }
}
```

### 2. ğŸŒ æœåŠ¡å™¨åŸŸåé…ç½®

åœ¨å¾®ä¿¡å°ç¨‹åºåå°é…ç½®æœåŠ¡å™¨åŸŸåï¼š
```
request åˆæ³•åŸŸå: https://your-domain.com
uploadFile åˆæ³•åŸŸå: https://your-domain.com
downloadFile åˆæ³•åŸŸå: https://your-domain.com
```

## ğŸ“± ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•å’ŒéªŒè¯

### 1. ğŸ§ª å¼€å‘ç¯å¢ƒæµ‹è¯•

#### å¼€å‘è€…å·¥å…·è®¾ç½®
```
è¯¦æƒ… â†’ æœ¬åœ°è®¾ç½®:
âœ… ä¸æ ¡éªŒåˆæ³•åŸŸåã€web-viewã€TLS ç‰ˆæœ¬ä»¥åŠ HTTPS è¯ä¹¦
âœ… å¢å¼ºç¼–è¯‘
```

#### æµ‹è¯•æ­¥éª¤
1. åœ¨å¼€å‘è€…å·¥å…·ä¸­è¿è¡Œå°ç¨‹åº
2. ç‚¹å‡»"å¾®ä¿¡ç™»å½•"æŒ‰é’®
3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
4. éªŒè¯ token æ˜¯å¦ä¿å­˜

### 2. ğŸ“± çœŸæœºæµ‹è¯•

#### ä½“éªŒç‰ˆæµ‹è¯•
1. ä¸Šä¼ ä»£ç åˆ°å¾®ä¿¡åå°
2. ç”Ÿæˆä½“éªŒç‰ˆäºŒç»´ç 
3. çœŸæœºæ‰«ç æµ‹è¯•
4. éªŒè¯å®Œæ•´ç™»å½•æµç¨‹

#### æµ‹è¯•è¦ç‚¹
- [ ] è·å– code æˆåŠŸ
- [ ] ç½‘ç»œè¯·æ±‚æ­£å¸¸
- [ ] Token ä¿å­˜æˆåŠŸ
- [ ] ç”¨æˆ·çŠ¶æ€æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†å®Œå–„

### 3. ğŸ” è°ƒè¯•ä¿¡æ¯

#### å°ç¨‹åºç«¯æ—¥å¿—
```javascript
console.log('ğŸš€ å¼€å§‹å¾®ä¿¡ç™»å½•æµç¨‹')
console.log('âœ… æ­¥éª¤1: è·å–åˆ° code:', code)
console.log('âœ… æ­¥éª¤2: æœåŠ¡å™¨è¿”å›ç»“æœ:', result)
console.log('âœ… æ­¥éª¤3: token å·²ä¿å­˜')
```

#### æœåŠ¡å™¨ç«¯æ—¥å¿—
```javascript
console.log('ğŸ“¡ æ”¶åˆ°ç™»å½•è¯·æ±‚ï¼Œcode:', code)
console.log('âœ… å¾®ä¿¡æœåŠ¡å™¨è¿”å›:', { openid, session_key: '***' })
console.log('ğŸ” ç”Ÿæˆè‡ªå®šä¹‰ token:', token)
```

## ğŸš€ éƒ¨ç½²æ¸…å•

### âœ… å°ç¨‹åºç«¯
- [ ] `utils/wechat-login.js` å·²é…ç½®æœåŠ¡å™¨åœ°å€
- [ ] `pages/login/login.js` ä½¿ç”¨æ–°çš„ç™»å½•æ–¹æ³•
- [ ] `app.json` æƒé™é…ç½®æ­£ç¡®
- [ ] å¼€å‘è€…å·¥å…·è®¾ç½®æ­£ç¡®

### âœ… åç«¯æœåŠ¡å™¨
- [ ] API æœåŠ¡å™¨å·²éƒ¨ç½²
- [ ] å¾®ä¿¡é…ç½®å·²å¡«å…¥
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] Token éªŒè¯ä¸­é—´ä»¶å·²é…ç½®

### âœ… å¾®ä¿¡åå°
- [ ] æœåŠ¡å™¨åŸŸåå·²é…ç½®
- [ ] å°ç¨‹åºå·²å‘å¸ƒ
- [ ] AppID å’Œ AppSecret å·²è·å–
- [ ] æ¥å£æƒé™å·²å¼€é€š

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. "code æ— æ•ˆ"
**åŸå› **: code å·²ä½¿ç”¨è¿‡æˆ–è¿‡æœŸ
**è§£å†³**: é‡æ–°è°ƒç”¨ `wx.login()`

#### 2. "ç½‘ç»œè¯·æ±‚å¤±è´¥"
**åŸå› **: åŸŸåæœªé…ç½®æˆ–ç½‘ç»œé—®é¢˜
**è§£å†³**: æ£€æŸ¥åŸŸåé…ç½®å’Œç½‘ç»œè¿æ¥

#### 3. "token æ— æ•ˆ"
**åŸå› **: token è¿‡æœŸæˆ–æ ¼å¼é”™è¯¯
**è§£å†³**: é‡æ–°ç™»å½•è·å–æ–° token

#### 4. "è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥"
**åŸå› **: AppID æˆ– AppSecret é”™è¯¯
**è§£å†³**: æ£€æŸ¥å¾®ä¿¡é…ç½®ä¿¡æ¯

### è°ƒè¯•æŠ€å·§

#### æŸ¥çœ‹ç½‘ç»œè¯·æ±‚
```javascript
// åœ¨å°ç¨‹åºä¸­æŸ¥çœ‹è¯·æ±‚è¯¦æƒ…
wx.request({
  url: 'https://your-server.com/api/wechat/login',
  data: { code },
  success: (res) => {
    console.log('æœåŠ¡å™¨å“åº”:', res)
  },
  fail: (err) => {
    console.error('è¯·æ±‚å¤±è´¥:', err)
  }
})
```

#### éªŒè¯ Token
```javascript
// åœ¨çº¿ JWT éªŒè¯å·¥å…·
// https://jwt.io/
// ç²˜è´´ token æŸ¥çœ‹å†…å®¹
```

## ğŸ“‹ å®Œæ•´ä»£ç ç»“æ„

```
travel-planning2.0/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ wechat-login.js          âœ… å¾®ä¿¡ç™»å½•æœåŠ¡
â”‚   â”œâ”€â”€ auth.js                âœ… è®¤è¯å·¥å…·
â”‚   â””â”€â”€ supabase.js           âœ… æ•°æ®åº“è¿æ¥
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ login/
â”‚       â”œâ”€â”€ login.js            âœ… ç™»å½•é¡µé¢ï¼ˆå·²æ›´æ–°ï¼‰
â”‚       â”œâ”€â”€ login.wxml          âœ… ç™»å½•ç•Œé¢
â”‚       â””â”€â”€ login.wxss          âœ… æ ·å¼
â”œâ”€â”€ api-examples/
â”‚   â””â”€â”€ wechat-login-api.js     âœ… åç«¯ API ç¤ºä¾‹
â””â”€â”€ é…ç½®æŒ‡å—/
    â”œâ”€â”€ å¾®ä¿¡ç™»å½•å®˜æ–¹æµç¨‹å®æ–½æŒ‡å—.md
    â””â”€â”€ å¾®ä¿¡æˆæƒé…ç½®æŒ‡å—.md
```

---

**ğŸ‰ å®Œæˆé…ç½®åï¼Œä½ çš„å¾®ä¿¡ç™»å½•å°†å®Œå…¨ç¬¦åˆå¾®ä¿¡å®˜æ–¹æ¨èçš„å®‰å…¨æ ‡å‡†ï¼**

æŒ‰ç…§è¿™ä¸ªæŒ‡å—å®æ–½ï¼Œå¯ä»¥ç¡®ä¿ï¼š
- âœ… å®‰å…¨æ€§ï¼šç¬¦åˆå¾®ä¿¡å®‰å…¨è§„èŒƒ
- âœ… å¯é æ€§ï¼šç¨³å®šçš„ä¸‰æ–¹äº¤äº’
- âœ… å¯ç»´æŠ¤æ€§ï¼šæ¸…æ™°çš„ä»£ç ç»“æ„
- âœ… å¯æ‰©å±•æ€§ï¼šæ”¯æŒåç»­åŠŸèƒ½æ‰©å±•