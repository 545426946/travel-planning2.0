# 🔧 微信授权登录配置指南

## 📋 必需配置清单

### 1. 📱 小程序基础配置

#### ✅ app.json 权限配置（已完成）
```json
{
  "permission": {
    "scope.userLocation": {
      "desc": "你的位置信息将用于小程序位置接口的效果展示"
    },
    "scope.userInfo": {
      "desc": "您的微信头像、昵称等用户信息将用于完善会员资料，提供更好的个性化服务"
    }
  }
}
```

### 2. 🌐 微信开发者工具配置

#### 🔍 项目设置检查
在微信开发者工具中，确保以下设置正确：

1. **AppID 配置**
   ```
   工具 → 设置 → 项目设置 → 基本信息
   ✅ 确保 AppID 已填写
   ✅ 确保项目名称正确
   ```

2. **不校验合法域名选项**
   ```
   详情 → 本地设置
   ✅ 勾选 "不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
   ```

3. **增强编译选项**
   ```
   详情 → 本地设置
   ✅ 勾选 "增强编译"
   ✅ 勾选 "不校验请求域名、TLS 版本以及 HTTPS 证书"
   ```

### 3. 🔧 小程序后台配置

#### 🌐 登录小程序后台
1. 访问：[https://mp.weixin.qq.com](https://mp.weixin.qq.com)
2. 使用小程序管理员账号登录

#### 📱 设置 → 基本设置
```
✅ 确认小程序已发布（或处于开发状态）
✅ 确认服务类目正确
✅ 确认小程序头像、名称等信息
```

#### 🔐 设置 → 接口设置
```
✅ 确认以下接口已开通：
   - 用户基本信息接口
   - 登录接口
   - 用户授权接口
```

#### 🔗 设置 → 开发设置
```
✅ AppID: （记录你的小程序 AppID）
✅ AppSecret: （妥善保管，不要泄露）
✅ 服务器域名: 
   - request 合法域名
   - uploadFile 合法域名  
   - downloadFile 合法域名
   - ws 合法域名
```

### 4. 🏗️ 开发环境配置

#### 📂 项目结构检查
确保以下文件存在且配置正确：
```
travel-planning2.0/
├── app.json          ✅ （已配置权限）
├── pages/login/
│   ├── login.js       ✅ （已实现授权逻辑）
│   ├── login.wxml     ✅ （已使用 open-type="getUserInfo"）
│   └── login.wxss     ✅
└── utils/
    ├── auth.js        ✅ （用户认证工具）
    └── supabase.js    ✅ （数据库连接）
```

#### 🔍 代码检查清单
```xml
<!-- login.wxml 中的按钮配置 -->
<button 
  open-type="getUserInfo"
  bindgetuserinfo="handleGetUserInfo"
  class="login-btn wechat-btn"
>
  微信授权登录
</button>
```

## ⚠️ 常见问题解决

### 问题1: 授权窗口不弹出
**解决方案**：
1. 确保使用 `open-type="getUserInfo"`
2. 检查网络连接
3. 清除开发者工具缓存
4. 重启开发者工具

### 问题2: 获取不到用户信息
**解决方案**：
1. 检查 `app.json` 中的 `permission` 配置
2. 确保用户点击了"允许"
3. 查看控制台错误信息

### 问题3: 真机调试失败
**解决方案**：
1. 确保小程序已上传并审核通过
2. 使用真机调试而非模拟器
3. 检查手机微信版本（建议最新版本）

### 问题4: 域名配置问题
**解决方案**：
1. 开发环境：勾选"不校验合法域名"
2. 生产环境：配置正确的服务器域名
3. 确保 Supabase 域名已添加到白名单

## 🎯 推荐的开发流程

### 1. 开发阶段
```
✅ 使用测试 AppID
✅ 开启"不校验合法域名"
✅ 开启"增强编译"
✅ 在开发者工具中测试
```

### 2. 真机测试
```
✅ 上传代码到小程序后台
✅ 使用体验版或开发版进行真机测试
✅ 测试不同机型和微信版本
```

### 3. 发布阶段
```
✅ 配置生产环境域名
✅ 取消"不校验合法域名"选项
✅ 提交审核
✅ 发布上线
```

## 🔍 调试技巧

### 查看授权状态
```javascript
// 在控制台中查看用户授权设置
wx.getSetting({
  success: (res) => {
    console.log('用户授权设置:', res.authSetting)
  }
})
```

### 模拟不同场景
1. **允许授权**: 点击"允许"按钮
2. **拒绝授权**: 点击"拒绝"按钮，测试游客模式
3. **网络异常**: 断网测试，查看错误处理

## 📱 真机调试配置

### 安卓调试
1. 手机连接 USB
2. 开启"USB 调试模式"
3. 在开发者工具中选择"真机调试"

### iOS 调试
1. 确保设备已信任开发者证书
2. 使用微信扫码功能
3. 选择"真机调试"

## 🎉 配置完成检查清单

### ✅ 开发者工具设置
- [ ] AppID 已填写
- [ ] 不校验合法域名已勾选
- [ ] 增强编译已开启
- [ ] 项目结构正确

### ✅ 小程序后台设置  
- [ ] 小程序已创建
- [ ] 接口权限已开通
- [ ] 服务器域名已配置
- [ ] AppID 和 AppSecret 已记录

### ✅ 代码实现
- [ ] app.json 权限已配置
- [ ] 登录按钮使用正确 open-type
- [ ] handleGetUserInfo 方法已实现
- [ ] 错误处理已完善

---

**配置完成后，微信授权登录应该能正常工作！**

如果还有问题，请查看控制台的具体错误信息，或者联系微信小程序技术支持。