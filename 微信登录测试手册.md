# 微信登录测试手册 🧪

## 🎯 快速测试步骤

### 第一步：检查开发环境
打开微信开发者工具，点击右上角"详情"，检查以下配置：

#### ✅ 基础库版本
- **要求**: ≥ 2.10.4
- **当前**: 查看"本地设置" → "调试基础库"
- **如何升级**: 下拉选择最新版本

#### ✅ AppID 配置
```json
// project.config.json
{
  "appid": "wxb9ca37c30f43d5b8"
}
```

#### ✅ 不校验合法域名
- 勾选"详情" → "本地设置" → "不校验合法域名、web-view、TLS版本以及HTTPS证书"

---

### 第二步：测试登录功能

#### 1️⃣ 打开登录页面
```
pages/login/login
```

#### 2️⃣ 点击"微信登录"标签
- 切换到微信登录方式

#### 3️⃣ 点击"微信一键登录"按钮
- **重要**: 必须点击按钮，不能点击其他区域

#### 4️⃣ 在弹窗中点击"允许"
- 授权获取昵称、头像等信息

#### 5️⃣ 查看控制台日志
应该看到以下日志输出：

```
=== 开始微信登录流程 ===
✅ wx.login 成功, code: 071xxxxx
✅ 获取用户信息成功: {nickName: "xxx", avatarUrl: "xxx"}
✅ 用户数据构建完成: {openid: "wx_xxx", name: "xxx"}
📝 尝试保存用户信息到数据库...
✅ 用户已存在, ID: xxx  (或: ✅ 新用户创建成功, ID: xxx)
✅ 登录用户信息: {...}
✅ 登录状态已保存
🏠 跳转到首页
```

---

## 🔍 常见问题排查

### ❌ 问题1: 点击按钮没有反应

**可能原因**:
- 按钮没有绑定 `bindtap` 事件
- JavaScript 代码有语法错误

**解决方法**:
1. 检查 `login.wxml`:
```xml
<button bindtap="wechatLogin" class="wechat-login-btn">
  微信一键登录
</button>
```

2. 打开控制台查看是否有错误

3. 在 `login.js` 中添加测试代码:
```javascript
wechatLogin() {
  console.log('✅ 按钮点击事件触发了')
  // ... 其他代码
}
```

---

### ❌ 问题2: 弹出授权框，但点击"允许"后报错

**错误日志**:
```
❌ 微信登录失败: Error: getUserProfile:fail xxx
```

**可能原因**:
- 基础库版本太低
- 小程序配置问题
- 网络问题

**解决方法**:

#### 方案A: 升级基础库
1. 点击"详情" → "本地设置"
2. 调试基础库选择 `2.19.4` 或更高
3. 重新编译

#### 方案B: 检查网络
1. 确保电脑网络正常
2. 关闭 VPN 或代理
3. 尝试切换网络

#### 方案C: 清除缓存
1. 点击"清缓存" → "全部清除"
2. 重新编译
3. 再次测试

---

### ❌ 问题3: 授权成功，但保存数据库失败

**错误日志**:
```
⚠️ 查询用户失败: {...}
⚠️ 创建用户失败: {...}
⚠️ 数据库操作失败，但继续登录流程
```

**影响**: 
- ✅ **登录功能正常** (可以继续使用)
- ⚠️ 数据不会保存到数据库

**可能原因**:
- Supabase 配置错误
- 数据库表不存在
- 网络连接问题

**解决方法**:

#### 检查 Supabase 配置
```javascript
// utils/config.js
export const SUPABASE_URL = 'https://hmnjuntvubqvbpeyqoxw.supabase.co'
export const SUPABASE_ANON_KEY = 'eyJhbG...' // 你的密钥
```

#### 测试数据库连接
在控制台运行:
```javascript
const supabase = require('./utils/supabase').supabase
supabase.from('users').select('id').limit(1).then(res => {
  console.log('数据库连接测试:', res)
})
```

#### 验证表结构
确保 `users` 表存在并包含以下字段:
- `id` (主键)
- `name`
- `avatar`
- `gender`
- `city`
- `province`
- `country`
- `login_type`
- `created_at`
- `last_login`

---

### ❌ 问题4: 用户拒绝授权

**错误日志**:
```
❌ 微信登录失败: Error: getUserProfile:fail auth deny
您拒绝了授权，无法登录
```

**这是正常的**:
- 用户点击了"拒绝"按钮
- 需要用户重新点击"允许"

**引导方案**:
```javascript
wx.showModal({
  title: '需要您的授权',
  content: '为了给您提供更好的服务，我们需要获取您的昵称和头像',
  confirmText: '重新授权',
  success: (res) => {
    if (res.confirm) {
      // 用户点击重新授权
      this.wechatLogin()
    }
  }
})
```

---

## 📱 真机测试

### 方法1: 预览
1. 点击"预览"按钮
2. 用微信扫描二维码
3. 在手机上测试登录
4. **注意**: 真机上无法查看日志

### 方法2: 真机调试
1. 点击"真机调试"
2. 用微信扫描二维码
3. 在开发者工具控制台查看真机日志
4. **推荐**: 可以看到详细日志

### 方法3: 上传体验版
1. 点击"上传"
2. 填写版本号和说明
3. 登录微信公众平台
4. 设置体验版
5. 扫码体验

---

## 🧪 单元测试

### 测试 wx.login
```javascript
// 在控制台运行
wx.login({
  success: (res) => console.log('✅ wx.login 成功:', res),
  fail: (err) => console.error('❌ wx.login 失败:', err)
})
```

**预期结果**:
```javascript
✅ wx.login 成功: {
  errMsg: "login:ok",
  code: "071xxx..."
}
```

---

### 测试 getUserProfile
```javascript
// 必须在 button 的 bindtap 中调用
// 在 login.js 中添加测试方法
testGetUserProfile() {
  wx.getUserProfile({
    desc: '测试',
    success: (res) => console.log('✅ getUserProfile 成功:', res),
    fail: (err) => console.error('❌ getUserProfile 失败:', err)
  })
}
```

**WXML**:
```xml
<button bindtap="testGetUserProfile">测试获取用户信息</button>
```

**预期结果**:
```javascript
✅ getUserProfile 成功: {
  userInfo: {
    nickName: "张三",
    avatarUrl: "https://...",
    gender: 1,
    city: "深圳",
    province: "广东",
    country: "中国"
  }
}
```

---

### 测试数据库
```javascript
// 在控制台运行
const supabase = require('./utils/supabase').supabase

// 测试查询
supabase.from('users').select('*').limit(1)
  .then(res => console.log('✅ 查询成功:', res))
  .catch(err => console.error('❌ 查询失败:', err))

// 测试插入
supabase.from('users').insert({
  name: '测试用户',
  avatar: 'https://example.com/avatar.jpg',
  login_type: 'wechat',
  created_at: new Date().toISOString()
}).select()
  .then(res => console.log('✅ 插入成功:', res))
  .catch(err => console.error('❌ 插入失败:', err))
```

---

## 📊 测试清单

### 开发环境测试
- [ ] 微信开发者工具版本最新
- [ ] 基础库版本 ≥ 2.10.4
- [ ] AppID 配置正确
- [ ] 不校验合法域名已勾选
- [ ] 控制台无报错
- [ ] 点击按钮有响应
- [ ] 授权弹窗正常
- [ ] 允许授权后登录成功
- [ ] 跳转到首页成功
- [ ] 用户信息显示正确

### 真机测试
- [ ] 体验版可以正常打开
- [ ] 登录页面显示正常
- [ ] 点击微信登录按钮有响应
- [ ] 授权弹窗正常
- [ ] 登录成功
- [ ] 用户信息显示正确
- [ ] 退出登录正常
- [ ] 重新登录正常

### 数据库测试
- [ ] Supabase 配置正确
- [ ] 数据库连接正常
- [ ] users 表存在
- [ ] 表结构正确
- [ ] 可以查询数据
- [ ] 可以插入数据
- [ ] 可以更新数据

---

## 🎬 完整测试视频脚本

### 场景1: 首次登录
1. 打开小程序
2. 进入登录页面
3. 点击"微信登录"
4. 点击"微信一键登录"
5. 点击"允许"授权
6. ✅ 登录成功，跳转到首页
7. ✅ 显示用户昵称和头像

### 场景2: 重新登录
1. 退出登录
2. 重新进入登录页面
3. 点击"微信一键登录"
4. 点击"允许"授权
5. ✅ 登录成功
6. ✅ 使用之前的用户信息

### 场景3: 拒绝授权
1. 点击"微信一键登录"
2. 点击"拒绝"
3. ❌ 显示"您拒绝了授权，无法登录"
4. 再次点击"微信一键登录"
5. 点击"允许"
6. ✅ 登录成功

---

## 💡 调试技巧

### 1. 使用 console.log 定位问题
```javascript
wechatLogin() {
  console.log('1️⃣ 开始登录')
  
  try {
    console.log('2️⃣ 调用 wx.login')
    const loginRes = await this.wechatLoginRequest()
    console.log('3️⃣ wx.login 成功:', loginRes)
    
    console.log('4️⃣ 调用 getUserProfile')
    const userInfoRes = await this.getUserProfile()
    console.log('5️⃣ getUserProfile 成功:', userInfoRes)
    
    // ... 其他代码
  } catch (error) {
    console.log('❌ 在哪一步失败:', error)
  }
}
```

### 2. 使用 try-catch 捕获错误
```javascript
try {
  // 可能出错的代码
} catch (error) {
  console.error('错误详情:', error)
  console.error('错误消息:', error.errMsg)
  console.error('错误堆栈:', error.stack)
}
```

### 3. 使用断点调试
1. 在代码行号左侧点击，添加断点
2. 点击登录按钮
3. 代码会暂停在断点处
4. 查看变量值
5. 单步执行

---

## 📞 获取帮助

### 查看官方文档
- [wx.getUserProfile 文档](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html)
- [wx.login 文档](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)

### 微信开放社区
https://developers.weixin.qq.com/community/

### GitHub Issues
https://github.com/545426946/travel-planning2.0/issues

---

## ✅ 验收标准

### 功能正常的标志
- ✅ 点击按钮后弹出授权框
- ✅ 授权后显示"登录成功"
- ✅ 自动跳转到首页
- ✅ 首页显示用户昵称和头像
- ✅ 可以正常使用其他功能
- ✅ 退出登录正常
- ✅ 重新登录正常

### 控制台日志正常
```
=== 开始微信登录流程 ===
✅ wx.login 成功, code: xxx
✅ 获取用户信息成功: {...}
✅ 用户数据构建完成: {...}
✅ 登录用户信息: {...}
✅ 登录状态已保存
🏠 跳转到首页
```

---

## 🎉 成功案例

如果你看到以下界面，说明登录成功了：

1. **登录页面**: 点击按钮 → 弹出授权框 → 点击允许
2. **加载中**: 显示"登录成功"提示
3. **首页**: 
   - 顶部显示你的微信昵称
   - 顶部显示你的微信头像
   - 可以正常浏览内容
4. **个人页**:
   - 显示完整的用户信息
   - 显示统计数据

恭喜你，微信登录功能已经正常工作！🎊
