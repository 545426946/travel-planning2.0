# å¾®ä¿¡ç™»å½•æ¥å…¥è¶…çº§è¯¦ç»†æ­¥éª¤ï¼ˆSupabase åç«¯ï¼‰

æœ¬æ–‡ä»¶æŒ‡å¯¼ä½ ä»é›¶å®Œæˆå¾®ä¿¡ç™»å½•æ¥å…¥ï¼Œå¹¶ä¸ Supabase åç«¯æ‰“é€šã€‚æ¯ä¸€ä¸ªæ­¥éª¤éƒ½æ˜ç¡®ç‚¹å‡»è·¯å¾„ã€éœ€è¦å¡«å†™çš„å…·ä½“å€¼ã€æ—¥å¿—è§‚å¯Ÿç‚¹å’ŒéªŒè¯æ–¹æ³•ã€‚æŒ‰ç…§é¡ºåºæ‰§è¡Œå³å¯å®Œæˆä»»åŠ¡ã€‚

---

## ä¸€ã€ç›®æ ‡ä¸æ€»ä½“æµç¨‹
- ä½¿ç”¨ `wx.login` è·å– `code`ï¼Œæºå¸¦ç”¨æˆ·æˆæƒä¿¡æ¯è°ƒç”¨åç«¯ Edge Functionã€‚
- Edge Function è°ƒç”¨å¾®ä¿¡å®˜æ–¹ `jscode2session`ï¼Œå¾—åˆ° `openid` å’Œ `session_key`ï¼Œåœ¨ `users` è¡¨åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·ï¼Œç”Ÿæˆ 30 å¤©æœ‰æ•ˆçš„ `token` å¹¶è¿”å›ã€‚
- å°ç¨‹åºä¿å­˜ `token` ä¸ `userInfo`ï¼Œåç»­é¡µé¢é€šè¿‡ `Auth.getCurrentUserId()` åšæ•°æ®éš”ç¦»ï¼ˆåªæŸ¥è‡ªå·±çš„æ•°æ®ï¼‰ã€‚

---

## äºŒã€å‰æå‡†å¤‡
- å¾®ä¿¡å°ç¨‹åºåå°ï¼šç¡®è®¤ä½ æœ‰è¯¥å°ç¨‹åºçš„ `AppID` ä¸ `AppSecret`ã€‚
- Supabase é¡¹ç›®ï¼šç†Ÿæ‚‰é¡¹ç›®ç½‘å€ `https://hmnjuntvubqvbpeyqoxw.supabase.co`ï¼Œå‡†å¤‡å¥½ `Service Role Key`ï¼ˆåç«¯å‡½æ•°ç”¨ï¼‰ã€‚
- ä»£ç ä»“åº“ï¼šå½“å‰é¡¹ç›®å·²åŒ…å«å¾®ä¿¡ç™»å½•é¡µé¢ä¸ Edge Function é›å½¢ã€‚

---

## ä¸‰ã€åç«¯ Edge Function é…ç½®ä¸éƒ¨ç½²
Edge Function æ–‡ä»¶ï¼š`supabase/functions/wechat-login/index.ts`

1. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¿…åšï¼‰
   - æ‰“å¼€ Supabase æ§åˆ¶å° â†’ é¡¹ç›®è®¾ç½® â†’ Functions æˆ– Edge Functions ç¯å¢ƒé…ç½®ï¼Œæ–°å¢ï¼š
     - `SUPABASE_URL` = `https://hmnjuntvubqvbpeyqoxw.supabase.co`
     - `SUPABASE_SERVICE_ROLE_KEY` = ä½ çš„ Service Role Keyï¼ˆä»…åç«¯ä½¿ç”¨ï¼‰
     - `WECHAT_APP_ID` = ä½ çš„å¾®ä¿¡å°ç¨‹åº AppID
     - `WECHAT_APP_SECRET` = ä½ çš„å¾®ä¿¡å°ç¨‹åº AppSecret
     - å¯é€‰ï¼š`DEV_MODE` = `true`ï¼ˆå¼€å‘è°ƒè¯•é˜¶æ®µå¯ç”¨ï¼Œå‡½æ•°ä¼šè¿”å›æ¨¡æ‹Ÿçš„ openidï¼‰

2. ç¡®è®¤å‡½æ•°ä½¿ç”¨ `users` è¡¨ï¼ˆå·²ä¿®å¤ï¼‰
   - æŸ¥è¯¢/æ›´æ–°/æ’å…¥ç”¨æˆ·å‡æŒ‡å‘ `users` è¡¨ï¼š
     - æŸ¥è¯¢ï¼š`supabase/functions/wechat-login/index.ts:180`
     - æ›´æ–°ï¼š`supabase/functions/wechat-login/index.ts:202`
     - æ’å…¥ï¼š`supabase/functions/wechat-login/index.ts:261`

3. éƒ¨ç½²å‡½æ•°
   - ä½¿ç”¨ Supabase CLI:
     - å®‰è£… CLI ååœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼š
       - `supabase functions deploy wechat-login`
   - æˆ–åœ¨ Supabase æ§åˆ¶å°çš„ Edge Functions é¢æ¿ä¸­éƒ¨ç½²ã€‚

4. éªŒè¯å‡½æ•°è¿è¡Œ
   - æ‰“å¼€å‡½æ•°æ—¥å¿—ï¼Œè§‚å¯Ÿæ”¶åˆ°è¯·æ±‚æ—¶æ‰“å°ï¼š
     - `index.ts:13` æ˜¾ç¤ºâ€œğŸš€ Edge Function æ”¶åˆ°è¯·æ±‚â€
     - `index.ts:169` æ˜¾ç¤ºâ€œâœ… å¾®ä¿¡è®¤è¯æˆåŠŸï¼Œè·å–åˆ° openidâ€
     - æˆåŠŸè¿”å› 200 å“åº”å¹¶åŒ…å« `{ success: true, token, userInfo }`ã€‚

---

## å››ã€æ•°æ®åº“ç»“æ„ä¸ç­–ç•¥
è¿ç§»æ–‡ä»¶ï¼š`supabase/migrations/20241124_create_wechat_login_tables.sql`

- å…³é”®è¡¨ï¼š
  - `users`ï¼šå­˜å‚¨å¾®ä¿¡ç”¨æˆ·ï¼ˆ`openid` å”¯ä¸€ï¼Œ`id` ä¸ºä¸»é”®ï¼‰ã€‚
  - `user_sessions`ï¼šå­˜å‚¨ç™»å½•ä¼šè¯ä¸ `token`ï¼Œè¿‡æœŸæ—¶é—´é»˜è®¤ 30 å¤©ã€‚
  - `login_logs`ã€`user_roles`ã€`user_role_assignments`ï¼šå¯é€‰çš„å®¡è®¡ä¸è§’è‰²ç®¡ç†ã€‚

- RLS æé†’ï¼š
  - è¯¥è¿ç§»ä¸ºä¸Šè¿°è¡¨å¯ç”¨äº† RLS ç­–ç•¥ï¼Œç­–ç•¥ä½¿ç”¨ `auth.uid()` ä¸ `openid` çš„æ–‡æœ¬åŒ¹é…ã€‚
  - å½“å‰å‰ç«¯è°ƒç”¨ Rest API ä½¿ç”¨çš„æ˜¯ `anon` keyï¼ŒRLS ä¸ä¼šæŒ‰ç”¨æˆ·éš”ç¦»ç”Ÿæ•ˆï¼›å¯¹ `users` è¡¨çš„å†™æ“ä½œç”± Edge Functionï¼ˆService Role Keyï¼‰æ‰§è¡Œï¼Œå®‰å…¨æ— é—®é¢˜ã€‚
  - è¡Œç¨‹ç­‰ä¸šåŠ¡è¡¨è¯·ç»§ç»­ä½¿ç”¨å‰ç«¯çš„ `user_id` è¿‡æ»¤ï¼ˆå¦‚ï¼šåªæŸ¥å½“å‰ç”¨æˆ·æ•°æ®ï¼‰ã€‚

---

## äº”ã€å¾®ä¿¡å°ç¨‹åºæ§åˆ¶å°è®¾ç½®
1. å¼€å‘è®¾ç½® â†’ æœåŠ¡å™¨åŸŸåï¼šæ·»åŠ  `https://hmnjuntvubqvbpeyqoxw.supabase.co` åˆ°â€œrequest åˆæ³•åŸŸåâ€ã€‚
2. AppID ä¸ AppSecretï¼šç¡®ä¿ä¸ä½ åœ¨ Edge Function ç¯å¢ƒå˜é‡ä¸­è®¾ç½®çš„å€¼ä¸€è‡´ã€‚
3. çœŸæœºè°ƒè¯•ï¼šå»ºè®®åœ¨çœŸæœºä¸Šæµ‹è¯•æˆæƒç™»å½•æµç¨‹ï¼ˆ`getUserInfo` åœ¨éƒ¨åˆ†ç¯å¢ƒå—é™ï¼ŒçœŸæœºä¼˜å…ˆä½¿ç”¨ `getUserProfile`ï¼‰ã€‚

---

## å…­ã€å‰ç«¯ä»£ç é…ç½®ä¸å…¥å£
å·²å­˜åœ¨çš„å…³é”®æ–‡ä»¶ï¼š
- ç™»å½•é¡µé€»è¾‘ï¼š`pages/login/login.js`
- ç™»å½•é¡µè§†å›¾ï¼š`pages/login/login.wxml`
- å¾®ä¿¡ç™»å½•æœåŠ¡ï¼š`utils/wechat-login.js`
- è®¤è¯å·¥å…·ï¼š`utils/auth.js`
- Supabase HTTP å°è£…ï¼š`utils/supabase.js`

1. æ£€æŸ¥å¾®ä¿¡ç™»å½•æŒ‰é’®ï¼ˆè§†å›¾ï¼‰
   - æ–‡ä»¶ï¼š`pages/login/login.wxml:113`
   - æŒ‰é’®ï¼š
     - `open-type="getUserInfo"`
     - `bindgetuserinfo="handleWechatLoginWithUserInfo"`
   - æç¤ºï¼šçœŸæœºå¯ä½¿ç”¨ `getUserProfile` æµç¨‹ï¼ˆè§ `pages/login/login.js:315`ï¼‰ã€‚

2. ç™»å½•å…¥å£ï¼ˆé€»è¾‘ï¼‰
   - å…¥å£æ–¹æ³•ï¼š`pages/login/login.js:620` â†’ `handleWechatLoginWithUserInfo(e)`
     - ä» `e.detail.userInfo` è·å–å¤´åƒæ˜µç§°ç­‰ä¿¡æ¯
     - è°ƒç”¨ `wechatLogin.setUserInfo(userInfo)` å†™å…¥åˆ°æœåŠ¡ï¼ˆä¾›åç«¯ä½¿ç”¨ï¼‰
     - æ‰§è¡Œ `wechatLogin.login()` è§¦å‘ Edge Function è®¤è¯
   - æˆåŠŸåï¼šä¿å­˜ç™»å½•çŠ¶æ€å¹¶ `redirectToHome()`ï¼ˆ`pages/login/login.js:577`ï¼‰ã€‚

3. å¾®ä¿¡ç™»å½•æœåŠ¡ï¼ˆå°è£…ï¼‰
   - æ–‡ä»¶ï¼š`utils/wechat-login.js`
   - ä¸»æµç¨‹ï¼š`login()`ï¼ˆ`utils/wechat-login.js:41`ï¼‰
     - `getWxLoginCode()`ï¼š`utils/wechat-login.js:84`
     - `sendCodeToServer(code)`ï¼š`utils/wechat-login.js:98`ï¼Œå†…éƒ¨è°ƒç”¨ `callSupabaseFunction('wechat-login', data)`ï¼ˆ`utils/wechat-login.js:138`ï¼‰
     - æˆåŠŸåä¿å­˜ token ä¸ç”¨æˆ·ä¿¡æ¯ï¼š`utils/wechat-login.js:204`
   - å®‰å…¨æé†’ï¼šä¸è¦åœ¨å‰ç«¯å¡«å…¥ `AppSecret`ï¼ŒåŠ¡å¿…ä»…åœ¨ Edge Function ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ã€‚

4. è®¤è¯å·¥å…·ï¼ˆä¿å­˜ä¸è¯»å–ï¼‰
   - æ–‡ä»¶ï¼š`utils/auth.js`
   - ä¿å­˜ï¼š`Auth.saveUserLogin(userInfo, rememberMe)`ï¼ˆ`utils/auth.js:131`ï¼‰
   - è¯»å–å½“å‰ç”¨æˆ·ï¼š`Auth.getCurrentUser()`ï¼ˆ`utils/auth.js:24`ï¼‰ã€`Auth.getCurrentUserId()`ï¼ˆ`utils/auth.js:53`ï¼‰
   - é¡µé¢ç¤ºä¾‹ï¼š
     - `pages/plan-detail/plan-detail.js:20` åœ¨ `onLoad` æ£€æŸ¥ `options.id`
     - `pages/plan-detail/plan-detail.js:37` è·å– `userId = Auth.getCurrentUserId()`
     - æŸ¥è¯¢æ—¶å¸¦ä¸Š `user_id` æ¡ä»¶ï¼ˆä»…çœ‹è‡ªå·±çš„æ•°æ®ï¼‰

---

## ä¸ƒã€ä¸šåŠ¡æ•°æ®ä¸éš”ç¦»ï¼ˆé‡è¦ï¼‰
1. åˆ›å»º/æŸ¥è¯¢è¡Œç¨‹æ—¶å¿…é¡»ä½¿ç”¨å½“å‰ç”¨æˆ· ID è¿‡æ»¤ï¼š
   - ç¤ºä¾‹ï¼š`pages/plan-detail/plan-detail.js:37`ã€`pages/create-plan/create-plan.js:74`
2. æ’å…¥è¡Œç¨‹æ—¶å†™å…¥ `user_id`ï¼š
   - ç¤ºä¾‹ï¼š`pages/plan-detail/plan-detail.js:610` å¤åˆ¶è¡Œç¨‹æ—¶å°† `user_id: Auth.getCurrentUserId()` å†™å…¥æ–°è®°å½•ã€‚
3. è¿™æ ·å³ä¾¿ä½¿ç”¨åŒ¿å keyï¼Œå‰ç«¯ä¹Ÿèƒ½é€šè¿‡ç”¨æˆ· ID å®ç°â€œåªçœ‹è‡ªå·±çš„æ•°æ®â€çš„æ•ˆæœã€‚

---

## å…«ã€ç«¯åˆ°ç«¯æµ‹è¯•æ­¥éª¤
1. æ¸…ç¼“å­˜ä¸ç¼–è¯‘
   - å¾®ä¿¡å¼€å‘è€…å·¥å…· â†’ æ¸…ç¼“å­˜ â†’ å…¨éƒ¨æ¸…é™¤ â†’ é‡æ–°ç¼–è¯‘ã€‚

2. æˆæƒç™»å½•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
   - åˆ‡æ¢åˆ°â€œå¾®ä¿¡ç™»å½•â€æ ‡ç­¾ï¼ˆ`pages/login/login.wxml`ï¼‰
   - ç‚¹å‡»â€œå¾®ä¿¡ç™»å½•â€ï¼ŒæŸ¥çœ‹ Consoleï¼š
     - å‰ç«¯æ—¥å¿—ï¼ˆç¤ºä¾‹ï¼‰ï¼š
       - `utils/wechat-login.js:47` æ‰“å°â€œè·å–åˆ° codeâ€
       - `utils/wechat-login.js:117` æ‰“å°â€œEdge Functionè®¤è¯æˆåŠŸâ€
       - `pages/login/login.js:655` æ‰“å°â€œå¾®ä¿¡ç™»å½•æˆåŠŸ! token ä¸ userInfoâ€
     - åç«¯æ—¥å¿—ï¼ˆå‡½æ•°ï¼‰ï¼š
       - `index.ts:13` æ‰“å°â€œæ”¶åˆ°è¯·æ±‚â€
       - `index.ts:169` æ‰“å°â€œè·å–åˆ° openidâ€
       - `index.ts:333` æ‰“å°â€œç”¨æˆ·ä¼šè¯åˆ›å»ºæˆåŠŸï¼Œè¿”å› 200â€

3. æ•°æ®åº“æ£€æŸ¥
   - Supabase æ§åˆ¶å° â†’ Table Editorï¼š
     - `users` è¡¨ï¼šåº”æ–°å¢ä¸€æ¡ `openid` å¯¹åº”è®°å½•
     - `user_sessions` è¡¨ï¼šåº”æ–°å¢ä¸€æ¡ `token` è®°å½•ï¼Œ`expires_at` ä¸º 30 å¤©å

4. ä¸šåŠ¡éªŒè¯
   - ç™»å½•åè¿›å…¥é¦–é¡µï¼Œå°è¯•â€œåˆ›å»ºè¡Œç¨‹â€ä¸â€œæŸ¥çœ‹è¡Œç¨‹è¯¦æƒ…â€ï¼š
     - æ–°å»ºè¡Œç¨‹æ—¶ç¡®è®¤å†™å…¥äº† `user_id = Auth.getCurrentUserId()`
     - æŸ¥è¯¢æ—¶ç¡®è®¤å¸¦ `user_id` æ¡ä»¶ï¼ˆä»…è¿”å›è‡ªå·±çš„è¡Œç¨‹ï¼‰

---

## ä¹ã€ä¸Šçº¿éƒ¨ç½²æ¸…å•
- Supabase Edge Functionï¼šå·²éƒ¨ç½²ä¸”ç¯å¢ƒå˜é‡æ­£ç¡®ã€‚
- å¾®ä¿¡å°ç¨‹åºåå°ï¼šå·²è®¾ç½®åˆæ³•åŸŸåï¼ŒAppID/Secret æ­£ç¡®ã€‚
- å‰ç«¯ï¼šä¸åŒ…å«ä»»ä½•æ•æ„Ÿå¯†é’¥ï¼ˆä¸è¦åœ¨å‰ç«¯ä¿å­˜ AppSecret æˆ– Service Role Keyï¼‰ã€‚
- GitHubï¼šä»£ç å·²æ¨é€åˆ° `main` åˆ†æ”¯ï¼ˆ`https://github.com/545426946/travel-planning2.0.git`ï¼‰ã€‚

---

## åã€å¸¸è§é—®é¢˜ä¸è§£å†³
- ç‚¹å‡»æŒ‰é’®æ— æˆæƒå¼¹çª—ï¼š
  - æ£€æŸ¥ `open-type="getUserInfo"` ä¸ç»‘å®šæ–¹æ³•ï¼›çœŸæœºå»ºè®®æ”¹ç”¨ `getUserProfile`ï¼ˆ`pages/login/login.js:315`ï¼‰ã€‚
- Edge Function æŠ¥ç¯å¢ƒå˜é‡ç¼ºå¤±ï¼š
  - åœ¨å‡½æ•°ç¯å¢ƒä¸­è¡¥é½å››ä¸ªå˜é‡ï¼ˆ`SUPABASE_URL`ã€`SUPABASE_SERVICE_ROLE_KEY`ã€`WECHAT_APP_ID`ã€`WECHAT_APP_SECRET`ï¼‰ã€‚
- è¿”å› 500 é”™è¯¯ï¼š
  - `index.ts:121` çš„å¾®ä¿¡ API è¯·æ±‚å¯èƒ½è¶…æ—¶æˆ– Secret é”™è¯¯ï¼›å…ˆè®¾ç½® `DEV_MODE=true` éªŒè¯é“¾è·¯ï¼Œå†åˆ‡å›çœŸå®å€¼ã€‚
- å‰ç«¯æç¤ºâ€œè¯·å…ˆç™»å½•â€ï¼š
  - ç¡®è®¤ `Auth.saveUserLogin(...)` å·²æ‰§è¡Œä¸”æœ¬åœ°å­˜å‚¨æœ‰ `userInfo` ä¸ `authToken`ã€‚

---

## åä¸€ã€å…³é”®ä»£ç ä½ç½®ç´¢å¼•
- `pages/login/login.wxml:113` å¾®ä¿¡ç™»å½•æŒ‰é’®å®šä¹‰
- `pages/login/login.js:620` å¾®ä¿¡æˆæƒç™»å½•å…¥å£ï¼ˆ`handleWechatLoginWithUserInfo`ï¼‰
- `pages/login/login.js:203` ç™»å½•å®Œæˆä¿å­˜ä¸è·³è½¬ï¼ˆ`completeWechatLogin`ï¼‰
- `utils/wechat-login.js:41` å¾®ä¿¡ç™»å½•ä¸»æµç¨‹ï¼ˆ`login()`ï¼‰
- `utils/wechat-login.js:138` è°ƒç”¨ Edge Functionï¼ˆ`callSupabaseFunction`ï¼‰
- `utils/auth.js:53` è·å–å½“å‰ç”¨æˆ· IDï¼ˆ`getCurrentUserId`ï¼‰
- `pages/plan-detail/plan-detail.js:37` ä¸šåŠ¡æŸ¥è¯¢ä½¿ç”¨å½“å‰ç”¨æˆ· ID
- `pages/create-plan/create-plan.js:74` åŠ è½½ä¸ä¿å­˜è¡Œç¨‹ä½¿ç”¨å½“å‰ç”¨æˆ· ID
- `supabase/functions/wechat-login/index.ts:180/202/261` Edge Function æŸ¥è¯¢/æ›´æ–°/æ’å…¥ç”¨æˆ·

---

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œå¾®ä¿¡ç™»å½•å°†å…¨é¢æ¥å…¥å¹¶ä¸ Supabase åç«¯æ‰“é€šã€‚å¦‚æœéœ€è¦ç»§ç»­å‡çº§åˆ°â€œå‰åç«¯ç»Ÿä¸€åŸºäºç”¨æˆ· JWT çš„ RLS éš”ç¦»â€ï¼Œæˆ‘å¯ä»¥æä¾›è¿›é˜¶æŒ‡å—ä¸ä»£ç è°ƒæ•´å»ºè®®ã€‚ 

