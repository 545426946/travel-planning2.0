# 行程规划功能说明

## 📋 功能概述

已完成一个完整的行程规划管理系统，包括：
- ✅ 行程列表展示（从Supabase数据库读取）
- ✅ 行程详情页面（支持AI和手动创建的行程）
- ✅ 手动创建行程
- ✅ AI智能规划行程
- ✅ 行程编辑和删除

## 🎯 核心页面

### 1. 行程列表页 (`pages/travel-plans/travel-plans`)
**功能：**
- 展示用户的所有行程计划
- 支持按状态筛选（全部、计划中、进行中、已完成）
- AI生成和手动创建的行程都会显示
- 从Supabase数据库实时读取数据

**特点：**
- 美观的卡片式布局
- AI生成的行程带有🤖标识
- 显示行程天数、人数、预算等关键信息
- 支持查看和删除操作

**入口：**
- 首页底部Tab "行程规划"
- 首页 "新建行程" 按钮

### 2. 行程详情页 (`pages/plan-detail/plan-detail`)
**功能：**
- 展示完整的行程详细信息
- 支持按天查看每日行程安排
- 显示旅行风格、兴趣偏好、标签等
- 显示交通、住宿、特殊要求等信息

**特点：**
- 渐变头图展示
- 分天显示行程安排
- 自动解析AI生成的行程内容
- 提取活动的时间、地点、价格信息
- 支持编辑和删除

**数据来源：**
- AI生成：从`itinerary`字段解析
- 手动创建：显示用户填写的信息

### 3. 手动创建行程页 (`pages/create-plan/create-plan`)
**功能：**
- 手动创建新行程
- 编辑现有行程
- 完整的表单验证

**表单字段：**
- ✅ 行程标题（必填）
- ✅ 目的地（必填）
- ✅ 出行日期（必填）
- ✅ 出行人数
- ✅ 预算（必填）
- ✅ 旅行风格（经济、舒适、轻奢、奢华）
- ✅ 行程标签（多选）
- ✅ 行程描述
- ✅ 交通方式
- ✅ 住宿安排
- ✅ 特殊要求

**保存到数据库：**
- 自动计算总天数
- 设置`is_ai_generated = false`
- 保存到`travel_plans`表

### 4. AI智能规划页 (`pages/ai-plan/ai-plan`)
**功能：**
- 使用AI生成行程计划
- 自动保存到数据库

**表单字段：**
- 目的地
- 出行天数
- 出行人数
- 预算
- 旅行风格
- 兴趣偏好
- 特殊要求

**保存到数据库：**
- 设置`is_ai_generated = true`
- 保存完整的AI响应到`itinerary`字段
- 自动提取和保存元数据

## 🗄️ 数据库结构

### travel_plans 表字段

| 字段 | 类型 | 说明 | 来源 |
|------|------|------|------|
| id | uuid | 主键 | 自动生成 |
| user_id | uuid | 用户ID | 当前登录用户 |
| title | text | 行程标题 | 用户填写/AI生成 |
| destination | text | 目的地 | 用户填写 |
| description | text | 行程描述 | 用户填写/AI摘要 |
| start_date | date | 开始日期 | 用户选择/自动计算 |
| end_date | date | 结束日期 | 用户选择/自动计算 |
| total_days | integer | 总天数 | 自动计算 |
| travelers_count | integer | 出行人数 | 用户填写 |
| total_budget | numeric | 总预算 | 用户填写 |
| travel_style | text | 旅行风格 | 用户选择 |
| status | text | 状态 | planned/ongoing/completed |
| is_ai_generated | boolean | 是否AI生成 | true/false |
| tags | text[] | 标签数组 | 用户选择 |
| interests | jsonb | 兴趣偏好 | 用户选择（JSON） |
| transportation | text | 交通方式 | 用户填写/AI提取 |
| accommodation | text | 住宿安排 | 用户填写/AI提取 |
| special_requirements | text | 特殊要求 | 用户填写 |
| itinerary | text | 完整行程 | AI生成的完整内容 |
| created_at | timestamp | 创建时间 | 自动生成 |

## 🔄 数据流程

### AI生成行程流程
```
用户填写AI规划表单
  ↓
调用AI API生成行程内容
  ↓
解析表单数据 + AI响应
  ↓
保存到Supabase (is_ai_generated=true)
  ↓
跳转到行程列表
  ↓
点击查看详情
  ↓
自动解析行程内容显示
```

### 手动创建行程流程
```
用户填写创建行程表单
  ↓
表单验证
  ↓
保存到Supabase (is_ai_generated=false)
  ↓
跳转到行程列表
  ↓
点击查看详情
  ↓
显示用户填写的信息
```

## 📱 页面导航

### 入口1：首页底部Tab
- 点击 "行程规划" → `travel-plans`

### 入口2：行程列表
- 创建按钮 → 选择 AI/手动 → 对应页面
- 行程卡片 → `plan-detail`

### 入口3：详情页
- 编辑按钮 → `create-plan` (编辑模式)
- 删除按钮 → 删除后返回列表

## 🎨 UI特点

1. **渐变背景**：紫色渐变主题
2. **卡片式布局**：每个行程一个独立卡片
3. **标签展示**：AI标识、状态标签、兴趣标签
4. **图片展示**：使用picsum生成唯一图片
5. **响应式设计**：适配不同屏幕尺寸

## ✨ 特色功能

### 1. 智能行程解析
- 自动从AI响应中提取每日安排
- 识别时间、地点、活动、价格
- 结构化显示活动列表

### 2. 数据隔离
- 每个用户只能看到自己的行程
- 所有查询都带有 `user_id` 过滤

### 3. 双模式支持
- AI生成：快速智能
- 手动创建：完全自定义

### 4. 完整CRUD
- ✅ Create：AI生成 + 手动创建
- ✅ Read：列表 + 详情
- ✅ Update：编辑行程
- ✅ Delete：删除行程

## 🔧 技术实现

### 数据库操作
```javascript
// 查询用户行程
supabase
  .from('travel_plans')
  .select('*')
  .eq('user_id', userId)
  .order('created_at', { ascending: false })

// 创建行程
supabase
  .from('travel_plans')
  .insert(planData)
  .select()

// 更新行程
supabase
  .from('travel_plans')
  .update(planData)
  .eq('id', planId)
  .eq('user_id', userId)

// 删除行程
supabase
  .from('travel_plans')
  .delete()
  .eq('id', planId)
```

### AI集成
```javascript
// AI生成行程时传递表单数据
aiIntegration.planIntelligentItinerary(userId, userInput, formData, false)

// 解析并保存
parseAIResponseToPlan(aiResponse, userId, formData)
```

## 📝 使用说明

1. **查看行程**：首页点击"行程规划"Tab
2. **创建行程**：点击"手动创建"或"AI智能规划"
3. **查看详情**：在列表中点击任意行程卡片
4. **编辑行程**：在详情页点击"编辑行程"
5. **删除行程**：在列表或详情页点击"删除"

## ⚠️ 注意事项

1. 所有功能都需要用户登录
2. 数据完全来自Supabase数据库
3. AI生成的行程会自动保存
4. 手动创建的行程也会保存到同一张表
5. 行程详情会智能识别AI/手动创建的内容

## 🚀 后续优化建议

1. 添加行程分享功能
2. 支持导出行程为PDF
3. 集成地图显示路线
4. 添加行程协作功能
5. 支持行程模板
6. 添加费用记录功能
7. 支持上传行程图片
