# å¾®ä¿¡ç™»å½•ä½¿ç”¨è¯´æ˜

## ğŸ“± åŠŸèƒ½æ¦‚è¿°

æœ¬é¡¹ç›®å·²é›†æˆçœŸå®çš„å¾®ä¿¡ç™»å½•åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨è‡ªå·±çš„å¾®ä¿¡è´¦å·å¿«é€Ÿç™»å½•å°ç¨‹åºã€‚

## âœ¨ ç‰¹æ€§

- âœ… **çœŸå®å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯**: è·å–ç”¨æˆ·æ˜µç§°ã€å¤´åƒã€æ€§åˆ«ã€åœ°åŒºç­‰çœŸå®ä¿¡æ¯
- âœ… **è‡ªåŠ¨è´¦å·åˆ›å»º**: é¦–æ¬¡ç™»å½•è‡ªåŠ¨åˆ›å»ºç”¨æˆ·è´¦å·
- âœ… **æ•°æ®æŒä¹…åŒ–**: ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° Supabase æ•°æ®åº“
- âœ… **è‡ªåŠ¨ç™»å½•**: ç™»å½•åè‡ªåŠ¨è®°ä½ç”¨æˆ·ï¼Œä¸‹æ¬¡æ‰“å¼€å…ç™»å½•
- âœ… **ä¿¡æ¯åŒæ­¥**: æ¯æ¬¡ç™»å½•è‡ªåŠ¨æ›´æ–°ç”¨æˆ·æœ€æ–°ä¿¡æ¯

## ğŸ”‘ å¾®ä¿¡ç™»å½•æµç¨‹

### ç”¨æˆ·æ“ä½œæµç¨‹
1. æ‰“å¼€å°ç¨‹åºç™»å½•é¡µé¢
2. åˆ‡æ¢åˆ°"å¾®ä¿¡ç™»å½•"æ ‡ç­¾
3. ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"æŒ‰é’®
4. åœ¨å¼¹å‡ºçš„æˆæƒçª—å£ä¸­ç‚¹å‡»"å…è®¸"
5. æˆæƒæˆåŠŸåè‡ªåŠ¨ç™»å½•å¹¶è·³è½¬åˆ°é¦–é¡µ

### æŠ€æœ¯å®ç°æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®
    â†“
è°ƒç”¨ wx.getUserProfile() è·å–ç”¨æˆ·ä¿¡æ¯
    â†“
è°ƒç”¨ wx.login() è·å–ä¸´æ—¶ç™»å½•å‡­è¯ code
    â†“
æŸ¥è¯¢æ•°æ®åº“æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·
    â†“
å­˜åœ¨ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯å’Œç™»å½•æ—¶é—´
ä¸å­˜åœ¨ï¼šåˆ›å»ºæ–°ç”¨æˆ·è®°å½•
    â†“
ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
    â†“
ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ
```

## ğŸ“ å…³é”®APIè¯´æ˜

### 1. wx.getUserProfile
è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆéœ€è¦ç”¨æˆ·æˆæƒï¼‰

**è¿”å›æ•°æ®**:
```javascript
{
  userInfo: {
    nickName: "ç”¨æˆ·æ˜µç§°",
    avatarUrl: "ç”¨æˆ·å¤´åƒURL",
    gender: 1,  // 0-æœªçŸ¥ 1-ç”·æ€§ 2-å¥³æ€§
    city: "åŸå¸‚",
    province: "çœä»½",
    country: "å›½å®¶"
  }
}
```

### 2. wx.login
è·å–ç™»å½•å‡­è¯ code

**è¿”å›æ•°æ®**:
```javascript
{
  code: "071xxxxxx"  // ä¸´æ—¶ç™»å½•å‡­è¯
}
```

**æ³¨æ„**: 
- code æœ‰æ•ˆæœŸä¸º 5 åˆ†é’Ÿ
- ç”Ÿäº§ç¯å¢ƒåº”è¯¥å°† code å‘é€åˆ°åç«¯ï¼Œåç«¯è°ƒç”¨å¾®ä¿¡ API æ¢å– openid å’Œ session_key
- å½“å‰å®ç°ä½¿ç”¨ code ç”Ÿæˆä¸´æ—¶ openidï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰

## ğŸ’¾ æ•°æ®åº“å­—æ®µè¯´æ˜

### users è¡¨å­—æ®µ
```sql
- id: ç”¨æˆ·IDï¼ˆä¸»é”®ï¼‰
- openid: å¾®ä¿¡openidï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
- name: ç”¨æˆ·æ˜µç§°
- avatar: ç”¨æˆ·å¤´åƒURL
- gender: æ€§åˆ«ï¼ˆ0-æœªçŸ¥ 1-ç”·æ€§ 2-å¥³æ€§ï¼‰
- city: åŸå¸‚
- province: çœä»½
- country: å›½å®¶
- login_type: ç™»å½•ç±»å‹ï¼ˆwechat/accountï¼‰
- created_at: åˆ›å»ºæ—¶é—´
- last_login: æœ€åç™»å½•æ—¶é—´
```

## ğŸ” å®‰å…¨è¯´æ˜

### å½“å‰å®ç°
- âœ… ä½¿ç”¨ `wx.getUserProfile` è·å–çœŸå®ç”¨æˆ·ä¿¡æ¯
- âœ… ç”¨æˆ·ä¿¡æ¯åŠ å¯†å­˜å‚¨åœ¨æœ¬åœ°
- âœ… æ”¯æŒé€€å‡ºç™»å½•æ¸…é™¤æ‰€æœ‰æ•°æ®
- âš ï¸ openid ä½¿ç”¨æ¨¡æ‹Ÿç”Ÿæˆï¼ˆä»…æ¼”ç¤ºç”¨ï¼‰

### ç”Ÿäº§ç¯å¢ƒå»ºè®®
ä¸ºäº†å®‰å…¨æ€§ï¼Œç”Ÿäº§ç¯å¢ƒåº”è¯¥ï¼š

1. **æ­å»ºåç«¯æœåŠ¡å™¨**
2. **å®ç°å®Œæ•´çš„å¾®ä¿¡ç™»å½•æµç¨‹**:
```
å°ç¨‹åºç«¯                  åç«¯æœåŠ¡å™¨              å¾®ä¿¡æœåŠ¡å™¨
   â†“                          â†“                      â†“
wx.login()         â†’    æ¥æ”¶code
                   â†’    code + appid + secret  â†’  å¾®ä¿¡API
                   â†    è¿”å› openid + session_key
   â†    è¿”å›token
```

3. **åç«¯é…ç½®**:
```javascript
// åç«¯ç¤ºä¾‹ä»£ç ï¼ˆNode.jsï¼‰
const axios = require('axios')

async function getWechatOpenid(code) {
  const appid = 'your_appid'
  const secret = 'your_secret'
  const url = `https://api.weixin.qq.com/sns/jscode2session`
  
  const response = await axios.get(url, {
    params: {
      appid,
      secret,
      js_code: code,
      grant_type: 'authorization_code'
    }
  })
  
  return response.data
}
```

## ğŸ“± ä½¿ç”¨ç¤ºä¾‹

### é¡µé¢ä»£ç ç¤ºä¾‹
```javascript
// pages/login/login.js
wechatLogin() {
  // 1. è·å–ç”¨æˆ·ä¿¡æ¯
  wx.getUserProfile({
    desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™',
    success: async (userRes) => {
      // 2. å¾®ä¿¡ç™»å½•
      wx.login({
        success: async (loginRes) => {
          // 3. å‘é€åˆ°åç«¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
          // const result = await request.post('/api/wechat-login', {
          //   code: loginRes.code,
          //   userInfo: userRes.userInfo
          // })
          
          // 4. ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          Auth.saveUserLogin(userInfo, true)
          
          // 5. è·³è½¬é¦–é¡µ
          wx.switchTab({ url: '/pages/index/index' })
        }
      })
    }
  })
}
```

## ğŸ¯ æµ‹è¯•å»ºè®®

### å¼€å‘ç¯å¢ƒæµ‹è¯•
1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æµ‹è¯•
2. ç‚¹å‡»å¾®ä¿¡ç™»å½•æŒ‰é’®
3. åœ¨å¼¹å‡ºçš„æˆæƒçª—å£ä¸­ç‚¹å‡»"å…è®¸"
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤æµç¨‹

### çœŸæœºæµ‹è¯•
1. æ‰«ç é¢„è§ˆåˆ°æ‰‹æœº
2. ä½¿ç”¨çœŸå®å¾®ä¿¡è´¦å·ç™»å½•
3. éªŒè¯ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®è·å–
4. æ£€æŸ¥å¤´åƒå’Œæ˜µç§°æ˜¯å¦æ˜¾ç¤º

### æµ‹è¯•æ¸…å•
- [ ] é¦–æ¬¡ç™»å½•ï¼šåˆ›å»ºæ–°ç”¨æˆ·
- [ ] å†æ¬¡ç™»å½•ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯
- [ ] ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼šæ˜µç§°ã€å¤´åƒæ­£ç¡®
- [ ] é€€å‡ºç™»å½•ï¼šæ¸…é™¤æ‰€æœ‰æ•°æ®
- [ ] é‡æ–°ç™»å½•ï¼šè‡ªåŠ¨è¯†åˆ«å·²æœ‰è´¦å·
- [ ] æ‹’ç»æˆæƒï¼šæ˜¾ç¤ºå‹å¥½æç¤º

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦è°ƒç”¨ wx.getUserProfileï¼Ÿ
A: ä»åŸºç¡€åº“ 2.10.4 å¼€å§‹ï¼Œå¾®ä¿¡ä¸å†æ”¯æŒ `wx.getUserInfo` ç›´æ¥è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¿…é¡»ä½¿ç”¨ `wx.getUserProfile` å¹¶éœ€è¦ç”¨æˆ·ä¸»åŠ¨æˆæƒã€‚

### Q2: å¯ä»¥ä¸éœ€è¦ç”¨æˆ·æˆæƒå—ï¼Ÿ
A: ä¸å¯ä»¥ã€‚è·å–ç”¨æˆ·æ˜µç§°å’Œå¤´åƒå¿…é¡»ç»è¿‡ç”¨æˆ·æˆæƒï¼Œè¿™æ˜¯å¾®ä¿¡çš„éšç§ä¿æŠ¤æ”¿ç­–ã€‚

### Q3: openid æ˜¯ä»€ä¹ˆï¼Ÿ
A: openid æ˜¯ç”¨æˆ·åœ¨å½“å‰å°ç¨‹åºä¸­çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸åŒå°ç¨‹åºçš„åŒä¸€ç”¨æˆ· openid ä¸åŒã€‚

### Q4: å¦‚ä½•è·å–çœŸå®çš„ openidï¼Ÿ
A: éœ€è¦æ­å»ºåç«¯æœåŠ¡ï¼Œä½¿ç”¨ appidã€secret å’Œ code è°ƒç”¨å¾®ä¿¡ API æ¢å–ã€‚

### Q5: ç”¨æˆ·æ‹’ç»æˆæƒæ€ä¹ˆåŠï¼Ÿ
A: å½“å‰å®ç°ä¼šæ˜¾ç¤ºæç¤º"æ‚¨æ‹’ç»äº†æˆæƒï¼Œæ— æ³•ç™»å½•"ã€‚ç”¨æˆ·éœ€è¦é‡æ–°ç‚¹å‡»ç™»å½•å¹¶æˆæƒã€‚

## ğŸ”„ å‡çº§åˆ°ç”Ÿäº§ç¯å¢ƒ

### æ­¥éª¤1: ç”³è¯·å°ç¨‹åº
1. æ³¨å†Œå¾®ä¿¡å°ç¨‹åºè´¦å·
2. è·å– AppID å’Œ AppSecret

### æ­¥éª¤2: é…ç½®åç«¯æœåŠ¡
```javascript
// config.js
module.exports = {
  wechat: {
    appid: 'wx1234567890',  // ä½ çš„AppID
    secret: 'your_secret'    // ä½ çš„AppSecret
  }
}
```

### æ­¥éª¤3: å®ç°åç«¯æ¥å£
```javascript
// routes/auth.js
router.post('/wechat-login', async (req, res) => {
  const { code, userInfo } = req.body
  
  // 1. ç”¨codeæ¢å–openid
  const wxData = await getWechatOpenid(code)
  
  // 2. æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·
  const user = await User.findOrCreate({
    openid: wxData.openid,
    name: userInfo.nickName,
    avatar: userInfo.avatarUrl
  })
  
  // 3. ç”Ÿæˆtoken
  const token = generateToken(user.id)
  
  res.json({ success: true, token, user })
})
```

### æ­¥éª¤4: ä¿®æ”¹å°ç¨‹åºä»£ç 
```javascript
// è°ƒç”¨åç«¯æ¥å£
const response = await request.post('/api/wechat-login', {
  code: loginRes.code,
  userInfo: userRes.userInfo
})
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡å°ç¨‹åºç™»å½•æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)
- [è·å–ç”¨æˆ·ä¿¡æ¯æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html)
- [ç”¨æˆ·ä¿¡æ¯ä½¿ç”¨è§„èŒƒ](https://developers.weixin.qq.com/miniprogram/dev/framework/user-privacy/)

## ğŸ‰ æ€»ç»“

å½“å‰å®ç°ï¼š
- âœ… æ”¯æŒè·å–çœŸå®å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯
- âœ… è‡ªåŠ¨åˆ›å»ºå’Œæ›´æ–°ç”¨æˆ·è´¦å·
- âœ… æ•°æ®æŒä¹…åŒ–å­˜å‚¨
- âœ… å®Œæ•´çš„ç™»å½•ç™»å‡ºæµç¨‹

å»ºè®®ä¼˜åŒ–ï¼š
- ğŸ”„ æ­å»ºåç«¯æœåŠ¡è·å–çœŸå® openid
- ğŸ”„ å®ç° token åˆ·æ–°æœºåˆ¶
- ğŸ”„ æ·»åŠ ç”¨æˆ·ä¿¡æ¯æ›´æ–°åŠŸèƒ½
- ğŸ”„ å®Œå–„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘

---

**æ›´æ–°æ—¶é—´**: 2025-11-21  
**ç‰ˆæœ¬**: 2.0
