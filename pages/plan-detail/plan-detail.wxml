<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- è¡Œç¨‹è¯¦æƒ… -->
  <view wx:else class="plan-detail">
    <!-- è¿”å›æŒ‰é’® -->
    <view class="back-button" bindtap="navigateBack">
      <text>â† è¿”å›è¡Œç¨‹åˆ—è¡¨</text>
    </view>

    <!-- ç¼–è¾‘æ¨¡å¼æŒ‡ç¤ºå™¨ -->
    <view wx:if="{{editMode}}" class="edit-mode-indicator">
      <text>ğŸ“ ç¼–è¾‘æ¨¡å¼ - ç‚¹å‡»æ´»åŠ¨å¯ç¼–è¾‘</text>
    </view>

    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <view class="plan-header" bindtap="{{editMode ? 'showEditBasicInfo' : ''}}">
      <image class="header-image" src="{{plan.image}}" mode="aspectFill" />
      
      <view class="header-overlay">
        <view class="header-content">
          <view class="title-row">
            <text class="plan-title">{{plan.title}}</text>
            <view wx:if="{{editMode}}" class="edit-hint">
              <text>ç‚¹å‡»ç¼–è¾‘</text>
            </view>
          </view>
          
          <view class="plan-badges">
            <view wx:if="{{plan.isAIGenerated}}" class="badge ai-badge">
              <text>ğŸ¤– AIç”Ÿæˆ</text>
            </view>
            <view class="badge status-badge">
              <text>{{getStatusText(plan.status)}}</text>
            </view>
          </view>

          <view class="plan-meta">
            <view class="meta-row">
              <view class="meta-item">
                <text class="icon">ğŸ“…</text>
                <text>è¡Œç¨‹å¤©æ•°ï¼š{{plan.totalDays}}å¤©</text>
              </view>
              <view class="meta-item">
                <text class="icon">ğŸ‘¥</text>
                <text>å‡ºè¡Œäººæ•°ï¼š{{plan.travelers}}äºº</text>
              </view>
            </view>
            <view class="meta-row">
              <view class="meta-item">
                <text class="icon">ğŸ’°</text>
                <text>é¢„ç®—ï¼šÂ¥{{plan.budget}}</text>
              </view>
              <view class="meta-item">
                <text class="icon">ğŸ“</text>
                <text>ç›®çš„åœ°ï¼š{{plan.destination}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-bar">
      <button class="action-btn {{editMode ? 'active' : ''}}" bindtap="toggleEditMode">
        <text class="icon">{{editMode ? 'âœ…' : 'âœï¸'}}</text>
        <text>{{editMode ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
      </button>
      <button class="action-btn" bindtap="openMap">
        <text class="icon">ğŸ—ºï¸</text>
        <text>åœ°å›¾</text>
      </button>
      <button class="action-btn" bindtap="changeStatus">
        <text class="icon">ğŸ”„</text>
        <text>çŠ¶æ€</text>
      </button>
      <button class="action-btn" bindtap="showMoreActions">
        <text class="icon">â‹¯</text>
        <text>æ›´å¤š</text>
      </button>
    </view>

    <!-- è¡Œç¨‹å®‰æ’ -->
    <view class="itinerary-section">
      <view class="section-title">è¡Œç¨‹å®‰æ’</view>
      
      <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
      <scroll-view class="day-selector" scroll-x>
        <view class="day-tabs">
          <view wx:for="{{dailyItinerary}}" 
                wx:key="day"
                class="day-tab {{selectedDay === item.day ? 'active' : ''}}"
                bindtap="selectDay"
                data-day="{{item.day}}">
            <text class="day-label">ç¬¬{{item.day}}å¤©</text>
            <text class="day-date">{{item.date}}</text>
          </view>
        </view>
      </scroll-view>

      <!-- æ¯æ—¥è¯¦æƒ… -->
      <view wx:for="{{dailyItinerary}}" wx:key="day" wx:if="{{item.day === selectedDay}}" wx:for-index="dayIdx">
        <view class="daily-content">
          <!-- æ·»åŠ æ´»åŠ¨æŒ‰é’® -->
          <view wx:if="{{editMode}}" class="add-activity-btn" bindtap="showAddActivityModal">
            <text class="icon">â•</text>
            <text>æ·»åŠ æ´»åŠ¨</text>
          </view>

          <!-- å¦‚æœæœ‰ç»“æ„åŒ–çš„æ´»åŠ¨ -->
          <view wx:if="{{item.activities && item.activities.length > 0}}" class="activities-list">
            <view wx:for="{{item.activities}}" 
                  wx:key="index" 
                  wx:for-item="activity"
                  wx:for-index="actIdx"
                  class="activity-card {{editMode ? 'editable' : ''}} {{editingDayIndex === dayIdx && editingActivityIndex === actIdx ? 'editing' : ''}}"
                  bindtap="editActivity"
                  data-day-index="{{dayIdx}}"
                  data-activity-index="{{actIdx}}">
              
              <!-- æ­£åœ¨ç¼–è¾‘è¿™ä¸ªæ´»åŠ¨ -->
              <view wx:if="{{editingDayIndex === dayIdx && editingActivityIndex === actIdx}}" class="activity-edit-form">
                <view class="edit-form-row">
                  <text class="edit-label">æ—¶é—´</text>
                  <picker mode="time" value="{{editingActivity.time}}" bindchange="onEditTimeChange">
                    <view class="time-picker">{{editingActivity.time}}</view>
                  </picker>
                </view>
                <view class="edit-form-row">
                  <text class="edit-label">æ´»åŠ¨</text>
                  <input class="edit-input" value="{{editingActivity.title}}" 
                         data-field="title" bindinput="onEditActivityInput" 
                         placeholder="æ´»åŠ¨åç§°" />
                </view>
                <view class="edit-form-row">
                  <text class="edit-label">åœ°ç‚¹</text>
                  <input class="edit-input" value="{{editingActivity.location}}" 
                         data-field="location" bindinput="onEditActivityInput" 
                         placeholder="åœ°ç‚¹ï¼ˆé€‰å¡«ï¼‰" />
                </view>
                <view class="edit-form-row">
                  <text class="edit-label">è´¹ç”¨</text>
                  <input class="edit-input" type="digit" value="{{editingActivity.price}}" 
                         data-field="price" bindinput="onEditActivityInput" 
                         placeholder="è´¹ç”¨ï¼ˆé€‰å¡«ï¼‰" />
                </view>
                <view class="edit-form-actions">
                  <button class="edit-btn save-btn" bindtap="saveEditActivity">ä¿å­˜</button>
                  <button class="edit-btn cancel-btn" catchtap="cancelEditActivity">å–æ¶ˆ</button>
                  <button class="edit-btn delete-btn" catchtap="deleteActivity" 
                          data-day-index="{{dayIdx}}" data-activity-index="{{actIdx}}">åˆ é™¤</button>
                </view>
              </view>

              <!-- æ­£å¸¸æ˜¾ç¤ºæ´»åŠ¨ -->
              <view wx:else class="activity-display">
                <view class="activity-time-bar">
                  <text class="time-label">{{activity.time}}</text>
                </view>
                
                <view class="activity-content">
                  <view class="activity-header">
                    <text class="activity-title">{{activity.title}}</text>
                    <view wx:if="{{activity.price}}" class="activity-price">
                      <text>Â¥{{activity.price}}</text>
                    </view>
                  </view>
                  
                  <view wx:if="{{activity.location}}" class="activity-location">
                    <text class="icon">ğŸ“</text>
                    <text>{{activity.location}}</text>
                  </view>
                </view>

                <!-- ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºç¼–è¾‘å›¾æ ‡ -->
                <view wx:if="{{editMode}}" class="edit-icon">
                  <text>âœï¸</text>
                </view>
              </view>
            </view>
          </view>

          <!-- å¦‚æœæ²¡æœ‰ç»“æ„åŒ–çš„æ´»åŠ¨ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹ -->
          <view wx:elif="{{item.content && item.content !== 'æš‚æ— å®‰æ’'}}" class="raw-content">
            <text>{{item.content}}</text>
          </view>

          <!-- ç©ºçŠ¶æ€ -->
          <view wx:else class="empty-day">
            <text class="empty-icon">ğŸ“­</text>
            <text class="empty-text">æš‚æ— æ´»åŠ¨å®‰æ’</text>
            <view wx:if="{{editMode}}" class="empty-hint">
              <text>ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ æ´»åŠ¨"å¼€å§‹è§„åˆ’</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è¡Œç¨‹æè¿° -->
    <view wx:if="{{plan.description}}" class="description-section">
      <view class="section-title">è¡Œç¨‹æè¿°</view>
      <text class="description-text">{{plan.description}}</text>
    </view>

    <!-- æ—…è¡Œé£æ ¼ -->
    <view wx:if="{{plan.travelStyle}}" class="info-section">
      <view class="section-title">æ—…è¡Œé£æ ¼</view>
      <view class="info-tag">
        <text>{{getTravelStyleText(plan.travelStyle)}}</text>
      </view>
    </view>

    <!-- å…´è¶£åå¥½ -->
    <view wx:if="{{plan.interests && plan.interests.length > 0}}" class="info-section">
      <view class="section-title">å…´è¶£åå¥½</view>
      <view class="tags-container">
        <view wx:for="{{plan.interests}}" wx:key="index" class="info-tag">
          <text>{{item.label || item}}</text>
        </view>
      </view>
    </view>

    <!-- æ ‡ç­¾ -->
    <view wx:if="{{plan.tags && plan.tags.length > 0}}" class="info-section">
      <view class="section-title">è¡Œç¨‹æ ‡ç­¾</view>
      <view class="tags-container">
        <view wx:for="{{plan.tags}}" wx:key="index" class="info-tag">
          <text>{{item}}</text>
        </view>
      </view>
    </view>

    <!-- äº¤é€šå’Œä½å®¿ -->
    <view class="logistics-section">
      <view wx:if="{{plan.transportation}}" class="logistics-item">
        <view class="section-title">äº¤é€šæ–¹å¼</view>
        <text class="logistics-text">{{plan.transportation}}</text>
      </view>
      
      <view wx:if="{{plan.accommodation}}" class="logistics-item">
        <view class="section-title">ä½å®¿å®‰æ’</view>
        <text class="logistics-text">{{plan.accommodation}}</text>
      </view>
    </view>

    <!-- ç‰¹æ®Šè¦æ±‚ -->
    <view wx:if="{{plan.specialRequirements}}" class="info-section">
      <view class="section-title">ç‰¹æ®Šè¦æ±‚</view>
      <text class="description-text">{{plan.specialRequirements}}</text>
    </view>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="bottom-actions">
      <button class="bottom-btn primary-btn" bindtap="toggleEditMode">
        <text>{{editMode ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘è¡Œç¨‹'}}</text>
      </button>
      <button class="bottom-btn secondary-btn" bindtap="showMoreActions">
        <text>æ›´å¤šæ“ä½œ</text>
      </button>
    </view>
  </view>

  <!-- æ·»åŠ æ´»åŠ¨å¼¹çª— -->
  <view wx:if="{{showAddModal}}" class="modal-overlay" catchtap="hideAddModal">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <text class="modal-title">æ·»åŠ æ´»åŠ¨</text>
        <text class="modal-close" bindtap="hideAddModal">âœ•</text>
      </view>
      
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">æ—¶é—´</text>
          <picker mode="time" value="{{newActivity.time}}" bindchange="onTimeChange">
            <view class="form-picker">{{newActivity.time}}</view>
          </picker>
        </view>
        
        <view class="form-item">
          <text class="form-label">æ´»åŠ¨åç§° *</text>
          <input class="form-input" value="{{newActivity.title}}" 
                 data-field="title" bindinput="onNewActivityInput" 
                 placeholder="ä¾‹å¦‚ï¼šå‚è§‚æ•…å®«åšç‰©é™¢" />
        </view>
        
        <view class="form-item">
          <text class="form-label">åœ°ç‚¹</text>
          <input class="form-input" value="{{newActivity.location}}" 
                 data-field="location" bindinput="onNewActivityInput" 
                 placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚ä¸œåŸåŒº" />
        </view>
        
        <view class="form-item">
          <text class="form-label">è´¹ç”¨ï¼ˆå…ƒï¼‰</text>
          <input class="form-input" type="digit" value="{{newActivity.price}}" 
                 data-field="price" bindinput="onNewActivityInput" 
                 placeholder="ä¾‹å¦‚ï¼š60" />
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideAddModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="addActivity">æ·»åŠ </button>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘åŸºæœ¬ä¿¡æ¯å¼¹çª— -->
  <view wx:if="{{showEditBasicModal}}" class="modal-overlay" catchtap="hideEditBasicModal">
    <view class="modal-content large" catchtap="">
      <view class="modal-header">
        <text class="modal-title">ç¼–è¾‘åŸºæœ¬ä¿¡æ¯</text>
        <text class="modal-close" bindtap="hideEditBasicModal">âœ•</text>
      </view>
      
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">è¡Œç¨‹æ ‡é¢˜ *</text>
          <input class="form-input" value="{{editBasicForm.title}}" 
                 data-field="title" bindinput="onBasicFormInput" 
                 placeholder="ç»™ä½ çš„æ—…è¡Œèµ·ä¸ªåå­—" />
        </view>
        
        <view class="form-item">
          <text class="form-label">ç›®çš„åœ°</text>
          <input class="form-input" value="{{editBasicForm.destination}}" 
                 data-field="destination" bindinput="onBasicFormInput" 
                 placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬" />
        </view>
        
        <view class="form-item">
          <text class="form-label">è¡Œç¨‹æè¿°</text>
          <textarea class="form-textarea" value="{{editBasicForm.description}}" 
                    data-field="description" bindinput="onBasicFormInput" 
                    placeholder="ç®€å•æè¿°ä¸€ä¸‹è¿™æ¬¡æ—…è¡Œ..." auto-height />
        </view>
        
        <view class="form-item">
          <text class="form-label">é¢„ç®—ï¼ˆå…ƒï¼‰</text>
          <input class="form-input" type="digit" value="{{editBasicForm.budget}}" 
                 data-field="budget" bindinput="onBasicFormInput" 
                 placeholder="é¢„è®¡æ€»é¢„ç®—" />
        </view>
        
        <view class="form-item">
          <text class="form-label">å‡ºè¡Œäººæ•°</text>
          <input class="form-input" type="number" value="{{editBasicForm.travelers}}" 
                 data-field="travelers" bindinput="onBasicFormInput" 
                 placeholder="1" />
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bindtap="hideEditBasicModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bindtap="saveBasicInfo" loading="{{saving}}">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view>
