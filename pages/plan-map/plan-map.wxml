<!-- æ—…è¡Œè®¡åˆ’åœ°å›¾é¡µé¢ - ä¼˜åŒ–ç‰ˆæœ¬ -->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-box">
      <view class="spinner"></view>
      <text class="loading-text">{{loadingText}}</text>
      <text wx:if="{{loadingProgress}}" class="loading-progress">{{loadingProgress}}</text>
    </view>
  </view>

  <!-- åœ°å›¾åŒºåŸŸ -->
  <map
    id="map"
    class="map"
    latitude="{{latitude}}"
    longitude="{{longitude}}"
    scale="{{scale}}"
    markers="{{markers}}"
    polyline="{{polyline}}"
    show-location
    enable-zoom
    enable-scroll
    bindmarkertap="onMarkerTap"
    bindcallouttap="onMarkerTap">
    
    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <cover-view class="top-bar">
      <cover-view class="back-btn" bindtap="goBack">
        <cover-view class="back-icon">â†</cover-view>
      </cover-view>
      <cover-view class="title-box">
        <cover-view class="title">{{plan.title || 'è¡Œç¨‹åœ°å›¾'}}</cover-view>
        <cover-view class="subtitle">
          <cover-view class="subtitle-item">ğŸ“ {{city || plan.destination}}</cover-view>
          <cover-view class="subtitle-item">ğŸ¯ {{attractions.length}}ä¸ªæ™¯ç‚¹</cover-view>
          <cover-view class="subtitle-item">ğŸ“ {{totalDistance}}km</cover-view>
        </cover-view>
      </cover-view>
    </cover-view>

    <!-- å³ä¾§å·¥å…·æ  -->
    <cover-view class="toolbar">
      <cover-view class="tool-btn" bindtap="locateMe">
        <cover-view class="tool-icon">ğŸ“</cover-view>
      </cover-view>
      <cover-view class="tool-btn" bindtap="showAllRoute">
        <cover-view class="tool-icon">ğŸ—ºï¸</cover-view>
      </cover-view>
      <cover-view class="tool-btn" bindtap="optimizeRoute">
        <cover-view class="tool-icon">âš¡</cover-view>
      </cover-view>
      <cover-view class="tool-btn" bindtap="addManually">
        <cover-view class="tool-icon">â•</cover-view>
      </cover-view>
      <cover-view class="tool-btn" bindtap="exportRoute">
        <cover-view class="tool-icon">ğŸ“¤</cover-view>
      </cover-view>
    </cover-view>

  </map>

  <!-- åº•éƒ¨æ™¯ç‚¹è¯¦æƒ…é¢æ¿ -->
  <view class="bottom-panel {{showAttractionList ? 'expanded' : 'collapsed'}}">
    <!-- é¢æ¿å¤´éƒ¨ -->
    <view class="panel-header" bindtap="toggleList">
      <view class="panel-header-left">
        <text class="panel-title">ğŸ—ºï¸ è¡Œç¨‹è·¯çº¿</text>
        <text class="panel-count">{{attractions.length}}ä¸ªæ™¯ç‚¹ Â· çº¦{{totalTimeText}}</text>
      </view>
      <view class="panel-toggle-btn">
        <text class="toggle-icon">{{showAttractionList ? 'â–¼' : 'â–²'}}</text>
      </view>
    </view>
    
    <!-- æ™¯ç‚¹åˆ—è¡¨ -->
    <scroll-view wx:if="{{showAttractionList}}" class="attraction-scroll" scroll-y enhanced show-scrollbar="{{false}}">
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{attractions.length === 0}}" class="empty-state">
        <view class="empty-icon">ğŸ—ºï¸</view>
        <text class="empty-title">æš‚æ— æ™¯ç‚¹æ•°æ®</text>
        <text class="empty-desc">è¡Œç¨‹å†…å®¹ä¸ºç©ºæˆ–æœªè¯†åˆ«åˆ°æ™¯ç‚¹</text>
        <view class="empty-actions">
          <button class="action-btn-empty" bindtap="reparse">ğŸ”„ é‡æ–°è§£æ</button>
          <button class="action-btn-empty primary" bindtap="addManually">â• æ‰‹åŠ¨æ·»åŠ </button>
        </view>
      </view>

      <!-- æ™¯ç‚¹æ—¶é—´çº¿ -->
      <view wx:if="{{attractions.length > 0}}" class="timeline">
        <view 
          wx:for="{{attractions}}" 
          wx:key="id" 
          class="timeline-item {{selectedAttractionId === item.id ? 'active' : ''}}"
          bindtap="focusAttraction" 
          data-id="{{item.id}}">
          
          <!-- æ—¶é—´çº¿å·¦ä¾§ -->
          <view class="timeline-left">
            <view class="timeline-number" style="background: {{item.id <= 8 ? ['#FF5722','#4CAF50','#2196F3','#9C27B0','#FF9800','#00BCD4','#E91E63','#3F51B5'][item.id-1] : '#999'}}">
              {{item.id}}
            </view>
            <view class="timeline-line" wx:if="{{index < attractions.length - 1}}">
              <view class="line-solid"></view>
              <view class="line-distance" wx:if="{{item.distanceToNext}}">{{item.distanceToNext}}km</view>
            </view>
          </view>
          
          <!-- æ™¯ç‚¹å¡ç‰‡ -->
          <view class="timeline-card">
            <view class="card-header">
              <view class="card-title-row">
                <text class="card-name">{{item.name}}</text>
                <view class="card-source {{item.source === 'local_db' ? 'local' : 'api'}}">
                  {{item.source === 'local_db' ? 'ğŸ“š' : item.source === 'amap_poi' ? 'ğŸ”' : 'ğŸ“'}}
                </view>
              </view>
              <view class="card-location" wx:if="{{item.address}}">
                <text class="location-icon">ğŸ“</text>
                <text class="location-text">{{item.address}}</text>
              </view>
            </view>
            
            <view class="card-footer">
              <view class="card-coords">
                <text class="coords-text">{{item.latitude.toFixed(4)}}, {{item.longitude.toFixed(4)}}</text>
              </view>
              <view class="card-actions">
                <view class="card-btn" catchtap="onMarkerTap" data-id="{{item.id}}">è¯¦æƒ…</view>
                <view class="card-btn nav" catchtap="quickNavigate" data-id="{{item.id}}">å¯¼èˆª</view>
              </view>
            </view>

            <!-- æ’åºå’Œåˆ é™¤æŒ‰é’® -->
            <view class="card-controls">
              <view class="control-btn {{index === 0 ? 'disabled' : ''}}" catchtap="moveUp" data-id="{{item.id}}">â†‘</view>
              <view class="control-btn {{index === attractions.length - 1 ? 'disabled' : ''}}" catchtap="moveDown" data-id="{{item.id}}">â†“</view>
              <view class="control-btn delete" catchtap="removeAttraction" data-id="{{item.id}}">Ã—</view>
            </view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨æ“ä½œåŒº -->
      <view wx:if="{{attractions.length > 0}}" class="list-footer">
        <view class="footer-stats">
          <view class="stat-item">
            <text class="stat-value">{{attractions.length}}</text>
            <text class="stat-label">æ™¯ç‚¹</text>
          </view>
          <view class="stat-divider"></view>
          <view class="stat-item">
            <text class="stat-value">{{totalDistance}}</text>
            <text class="stat-label">å…¬é‡Œ</text>
          </view>
          <view class="stat-divider"></view>
          <view class="stat-item">
            <text class="stat-value">{{totalTimeText}}</text>
            <text class="stat-label">é¢„è®¡</text>
          </view>
        </view>
        
        <view class="footer-actions">
          <button class="footer-btn" bindtap="addManually">â• æ·»åŠ æ™¯ç‚¹</button>
          <button class="footer-btn" bindtap="optimizeRoute">âš¡ ä¼˜åŒ–è·¯çº¿</button>
          <button class="footer-btn" bindtap="reparse">ğŸ”„ é‡æ–°è§£æ</button>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ™¯ç‚¹è¯¦æƒ…å¼¹çª— -->
  <view wx:if="{{showPanel}}" class="detail-modal">
    <view class="modal-mask" bindtap="closePanel"></view>
    <view class="modal-content">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="modal-header">
        <view class="modal-title-row">
          <view class="modal-number" style="background: {{selectedAttraction.id <= 8 ? ['#FF5722','#4CAF50','#2196F3','#9C27B0','#FF9800','#00BCD4','#E91E63','#3F51B5'][selectedAttraction.id-1] : '#999'}}">
            {{selectedAttraction.id}}
          </view>
          <text class="modal-title">{{selectedAttraction.name}}</text>
        </view>
        <view class="modal-close" bindtap="closePanel">Ã—</view>
      </view>
      
      <!-- å¼¹çª—å†…å®¹ -->
      <view class="modal-body">
        <view class="info-section">
          <view class="info-row">
            <view class="info-icon">ğŸ“</view>
            <view class="info-content">
              <text class="info-label">åœ°å€</text>
              <text class="info-value">{{selectedAttraction.address || 'æš‚æ— è¯¦ç»†åœ°å€'}}</text>
            </view>
          </view>
          
          <view class="info-row">
            <view class="info-icon">ğŸŒ</view>
            <view class="info-content">
              <text class="info-label">åæ ‡</text>
              <text class="info-value">{{selectedAttraction.latitude}}, {{selectedAttraction.longitude}}</text>
            </view>
          </view>
          
          <view class="info-row">
            <view class="info-icon">ğŸ“¦</view>
            <view class="info-content">
              <text class="info-label">æ•°æ®æ¥æº</text>
              <view class="source-tag {{selectedAttraction.source === 'local_db' ? 'local' : 'api'}}">
                {{selectedAttraction.source === 'local_db' ? 'æœ¬åœ°æ•°æ®åº“' : selectedAttraction.source === 'amap_poi' ? 'é«˜å¾·POIæœç´¢' : selectedAttraction.source === 'amap_geo' ? 'é«˜å¾·åœ°ç†ç¼–ç ' : 'æ‰‹åŠ¨æ·»åŠ '}}
              </view>
            </view>
          </view>

          <view class="info-row" wx:if="{{selectedAttraction.distanceToNext}}">
            <view class="info-icon">â¡ï¸</view>
            <view class="info-content">
              <text class="info-label">åˆ°ä¸‹ä¸€ç«™</text>
              <text class="info-value highlight">{{selectedAttraction.distanceToNext}} å…¬é‡Œ</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å¼¹çª—åº•éƒ¨æŒ‰é’® -->
      <view class="modal-footer">
        <button class="modal-btn checkin" bindtap="checkinAttraction">
          <text class="btn-icon">ğŸ“¸</text>
          <text>æ‰“å¡</text>
        </button>
        <button class="modal-btn primary" bindtap="navigateTo">
          <text class="btn-icon">ğŸ§­</text>
          <text>å¯¼èˆªå‰å¾€</text>
        </button>
      </view>
    </view>
  </view>

  <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
  <view wx:if="{{showDebugInfo}}" class="debug-modal">
    <view class="modal-mask" bindtap="toggleDebug"></view>
    <view class="debug-content">
      <view class="debug-header">
        <text class="debug-title">ğŸ”§ è°ƒè¯•ä¿¡æ¯</text>
        <view class="modal-close" bindtap="toggleDebug">Ã—</view>
      </view>
      <scroll-view class="debug-scroll" scroll-y>
        <view class="debug-section">
          <text class="section-label">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</text>
          <view class="debug-item">
            <text>è¡Œç¨‹ID: {{planId}}</text>
          </view>
          <view class="debug-item">
            <text>è¯†åˆ«åŸå¸‚: {{city}}</text>
          </view>
          <view class="debug-item">
            <text>ç›®çš„åœ°: {{plan.destination}}</text>
          </view>
        </view>
        
        <view class="debug-section">
          <text class="section-label">ğŸ“Š è§£æç»Ÿè®¡</text>
          <view class="debug-item">
            <text>æå–æ™¯ç‚¹: {{debugInfo.extractedNames.length}}ä¸ª</text>
          </view>
          <view class="debug-item success">
            <text>å®šä½æˆåŠŸ: {{debugInfo.successCount}}ä¸ª</text>
          </view>
          <view class="debug-item fail">
            <text>å®šä½å¤±è´¥: {{debugInfo.failedCount}}ä¸ª</text>
          </view>
        </view>
        
        <view class="debug-section">
          <text class="section-label">ğŸ“ æå–çš„æ™¯ç‚¹åç§°</text>
          <view class="debug-tags">
            <text wx:for="{{debugInfo.extractedNames}}" wx:key="index" class="debug-tag">{{item}}</text>
            <text wx:if="{{debugInfo.extractedNames.length === 0}}" class="debug-empty">æ— </text>
          </view>
        </view>
        
        <view class="debug-section">
          <text class="section-label">ğŸ“„ åŸå§‹è¡Œç¨‹æ–‡æœ¬</text>
          <view class="debug-text-box">
            <text>{{debugInfo.rawText || 'æ— '}}</text>
          </view>
        </view>
      </scroll-view>
      <view class="debug-footer">
        <button class="debug-btn" bindtap="reparse">ğŸ”„ é‡æ–°è§£æ</button>
        <button class="debug-btn primary" bindtap="addManually">â• æ·»åŠ æ™¯ç‚¹</button>
      </view>
    </view>
  </view>

  <!-- æµ®åŠ¨è°ƒè¯•æŒ‰é’® -->
  <view class="float-debug-btn" bindtap="toggleDebug">ğŸ”§</view>
</view>
